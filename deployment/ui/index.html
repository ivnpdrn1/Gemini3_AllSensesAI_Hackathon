<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllSensesAI - Gemini Emergency Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
        }

        .runtime-health {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .runtime-health h2 {
            color: #333;
            margin-bottom: 16px;
            font-size: 18px;
        }

        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .health-item {
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #ddd;
        }

        .health-item.live {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .health-item.fallback {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .health-item.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .health-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .health-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .pipeline-steps {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .step {
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .step:hover {
            background: #e9ecef;
        }

        .step.active {
            background: #e7f3ff;
            border-left-color: #007bff;
        }

        .step.complete {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .step-title {
            font-weight: 600;
            color: #333;
        }

        .step-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #ddd;
            color: #666;
        }

        .step.complete .step-status {
            background: #28a745;
            color: white;
        }

        .step-content {
            margin-top: 12px;
            display: none;
        }

        .step.active .step-content {
            display: block;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: #666;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .analysis-result {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .analysis-result.show {
            display: block;
        }

        .risk-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 16px;
        }

        .risk-critical {
            background: #dc3545;
            color: white;
        }

        .risk-high {
            background: #fd7e14;
            color: white;
        }

        .risk-medium {
            background: #ffc107;
            color: #333;
        }

        .risk-low {
            background: #17a2b8;
            color: white;
        }

        .risk-none {
            background: #28a745;
            color: white;
        }

        .console-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .console-log .log-entry {
            margin-bottom: 4px;
        }

        .console-log .log-info {
            color: #4fc3f7;
        }

        .console-log .log-success {
            color: #81c784;
        }

        .console-log .log-warning {
            color: #ffb74d;
        }

        .console-log .log-error {
            color: #e57373;
        }

        .architecture-note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .architecture-note h3 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .architecture-note p {
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Vision Context Analysis Panel */
        .vision-context-panel { background: #f0f8ff; border: 2px solid #4a90e2; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .vision-context-panel h4 { margin: 0 0 15px 0; color: #2c5aa0; font-size: 1.2em; }
        .vision-status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-bottom: 15px; }
        .vision-status-badge.standby { background: #e9ecef; color: #6c757d; }
        .vision-status-badge.capturing { background: #fff3cd; color: #856404; animation: pulse 1.5s infinite; }
        .vision-status-badge.analyzing { background: #cfe2ff; color: #084298; animation: pulse 1.5s infinite; }
        .vision-status-badge.complete { background: #d1e7dd; color: #0f5132; }
        .vision-status-badge.error { background: #f8d7da; color: #842029; }
        .vision-explainer { background: #fff; padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 0.95em; color: #495057; border-left: 4px solid #4a90e2; }
        .vision-capture-policy { background: #fff; padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 0.9em; color: #6c757d; }
        .vision-placeholders { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0; color: #adb5bd; font-style: italic; }
        .vision-placeholders p { margin: 5px 0; }
        .vision-trigger-reason { background: #fff3cd; padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 0.95em; color: #856404; border-left: 4px solid #ffc107; }
        .vision-progress { background: #fff; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .vision-progress-item { display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 0.95em; }
        .vision-progress-item .icon { font-size: 1.2em; }
        .vision-thumbnails { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
        .vision-thumbnail { width: 120px; height: 90px; border-radius: 6px; object-fit: cover; border: 2px solid #dee2e6; }
        .vision-thumbnail.blurred { filter: blur(8px); }
        .vision-thumbnail-toggle { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-top: 8px; }
        .vision-thumbnail-toggle:hover { background: #5a6268; }
        .vision-findings { background: #fff; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .vision-findings ul { margin: 10px 0; padding-left: 20px; }
        .vision-findings li { margin: 6px 0; color: #495057; }
        .vision-confidence { background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0; display: inline-block; }
        .vision-confidence .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: bold; margin-left: 8px; }
        .vision-confidence .badge.low { background: #d1e7dd; color: #0f5132; }
        .vision-confidence .badge.medium { background: #fff3cd; color: #856404; }
        .vision-confidence .badge.high { background: #f8d7da; color: #842029; }
        .vision-evidence-indicator { background: #d1e7dd; padding: 10px 15px; border-radius: 6px; margin: 10px 0; color: #0f5132; font-weight: 500; border-left: 4px solid #198754; }
        .vision-why-helps { font-size: 0.85em; color: #6c757d; margin-top: 10px; font-style: italic; }
        .vision-frames-placeholder { margin: 15px 0; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>AllSensesAI - Gemini Emergency Detection</h1>
            <p class="subtitle">Google Gemini 1.5 Pro | CloudFront + Lambda | Production Runtime</p>
            <div style="font-size:14px;color:#667eea;margin-top:8px;font-weight:bold;background:#f0f8ff;padding:6px 12px;border-radius:6px;display:inline-block;">Build: GEMINI3-VISION-VIDEO-FIX-20260127</div>
        </div>

        <!-- Runtime Health Panel -->
        <div class="runtime-health">
            <h2>Runtime Health Check</h2>
            <div class="health-grid">
                <div class="health-item" id="health-gemini-status">
                    <div class="health-label">Gemini Client</div>
                    <div class="health-value">Initializing...</div>
                </div>
                <div class="health-item" id="health-model">
                    <div class="health-label">Model</div>
                    <div class="health-value">-</div>
                </div>
                <div class="health-item" id="health-sdk">
                    <div class="health-label">SDK Available</div>
                    <div class="health-value">-</div>
                </div>
                <div class="health-item" id="health-mode">
                    <div class="health-label">Mode</div>
                    <div class="health-value">-</div>
                </div>
                <div class="health-item" id="health-backend">
                    <div class="health-label">Backend</div>
                    <div class="health-value">Lambda</div>
                </div>
                <div class="health-item" id="health-deployment">
                    <div class="health-label">Deployment</div>
                    <div class="health-value">CloudFront</div>
                </div>
            </div>
        </div>

        <!-- Pipeline Steps -->
        <div class="pipeline-steps">
            <h2>Emergency Response Pipeline</h2>
            
            <!-- Step 1: Identity -->
            <div class="step complete" id="step1">
                <div class="step-header">
                    <div class="step-title">Step 1: Identity & Emergency Contacts</div>
                    <div class="step-status">Complete</div>
                </div>
                <div class="step-content">
                    <div class="input-group">
                        <label>Your Name</label>
                        <input type="text" id="input-name" value="Demo User" readonly>
                    </div>
                    <div class="input-group">
                        <label>Emergency Contact</label>
                        <input type="text" id="input-contact" value="+1-555-0100" readonly>
                    </div>
                </div>
            </div>

            <!-- Step 2: Location -->
            <div class="step complete" id="step2">
                <div class="step-header">
                    <div class="step-title">Step 2: Location Services</div>
                    <div class="step-status">Complete</div>
                </div>
                <div class="step-content">
                    <div class="input-group">
                        <label>Location</label>
                        <input type="text" id="input-location" value="37.7749, -122.4194 (San Francisco)" readonly>
                    </div>
                </div>
            </div>

            <!-- Step 3: Voice Capture -->
            <div class="step complete" id="step3">
                <div class="step-header">
                    <div class="step-title">Step 3: Voice/Text Capture</div>
                    <div class="step-status">Complete</div>
                </div>
                <div class="step-content">
                    <div class="input-group">
                        <label>Emergency Transcript</label>
                        <textarea id="input-transcript" placeholder="Enter emergency situation description...">Help me please, I don't feel safe. There's someone following me and I'm scared.</textarea>
                    </div>
                </div>
            </div>

            <!-- Step 4: Gemini Analysis -->
            <div class="step active" id="step4">
                <div class="step-header">
                    <div class="step-title">Step 4: Gemini Threat Analysis</div>
                    <div class="step-status">Ready</div>
                </div>
                <div class="step-content">
                    <!-- NEW: Visual Context Analysis Panel (Always Visible) - PLACED FIRST -->
                    <div id="visionContextPanel" class="vision-context-panel">
                        <h4>üé• Visual Context (Gemini Vision) ‚Äî Video Frames</h4>
                        
                        <div id="visionStatusBadge" class="vision-status-badge standby">
                            <span>Standby</span>
                        </div>
                        
                        <div id="visionExplainer" class="vision-explainer">
                            <p><strong>Standby:</strong> Activates automatically during detected risk to corroborate audio/text signals.</p>
                            <p><strong>Capture policy:</strong> Captures 1‚Äì3 video frames during emergency. No continuous recording.</p>
                        </div>
                        
                        <!-- Video Frames Placeholders (Always Visible Before Trigger) -->
                        <div id="visionFramesPlaceholder" class="vision-frames-placeholder">
                            <h5 style="margin: 10px 0; color: #6c757d; font-size: 1em;">üìπ Video Frames (Standby)</h5>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div class="frame-placeholder">
                                    <div style="width: 120px; height: 90px; background: #e9ecef; border: 2px dashed #adb5bd; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 0.85em; text-align: center; padding: 5px;">
                                        Frame 1<br>not captured
                                    </div>
                                </div>
                                <div class="frame-placeholder">
                                    <div style="width: 120px; height: 90px; background: #e9ecef; border: 2px dashed #adb5bd; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 0.85em; text-align: center; padding: 5px;">
                                        Frame 2<br>not captured
                                    </div>
                                </div>
                                <div class="frame-placeholder">
                                    <div style="width: 120px; height: 90px; background: #e9ecef; border: 2px dashed #adb5bd; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 0.85em; text-align: center; padding: 5px;">
                                        Frame 3<br>not captured
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="visionPlaceholders" class="vision-placeholders">
                            <p><strong>Findings:</strong> ‚Äî</p>
                            <p><strong>Confidence:</strong> ‚Äî</p>
                            <p><strong>Vision/Video Status:</strong> Standby</p>
                        </div>
                        
                        <div id="visionTriggerReason" class="vision-trigger-reason" style="display:none;">
                            <p><strong>Activated because:</strong> <span id="visionTriggerText">‚Äî</span></p>
                        </div>
                        
                        <div id="visionProgress" class="vision-progress" style="display:none;">
                            <div class="vision-progress-item">
                                <span class="icon" id="progressTrigger">‚è≥</span>
                                <span>Trigger received</span>
                            </div>
                            <div class="vision-progress-item">
                                <span class="icon" id="progressCapture">‚è≥</span>
                                <span>Capturing frames</span>
                            </div>
                            <div class="vision-progress-item">
                                <span class="icon" id="progressAnalyze">‚è≥</span>
                                <span>Analyzing environment</span>
                            </div>
                            <div class="vision-progress-item">
                                <span class="icon" id="progressPublish">‚è≥</span>
                                <span>Publishing findings</span>
                            </div>
                        </div>
                        
                        <div id="visionThumbnails" class="vision-thumbnails" style="display:none;">
                            <!-- Thumbnails will be inserted here -->
                        </div>
                        
                        <div id="visionFindings" class="vision-findings" style="display:none;">
                            <strong>Environmental Risk Indicators:</strong>
                            <ul id="visionFindingsList">
                                <!-- Findings will be inserted here -->
                            </ul>
                        </div>
                        
                        <div id="visionConfidence" class="vision-confidence" style="display:none;">
                            <strong>Confidence:</strong>
                            <span class="badge" id="visionConfidenceBadge">‚Äî</span>
                        </div>
                        
                        <div id="visionEvidenceIndicator" class="vision-evidence-indicator" style="display:none;">
                            ‚úÖ Added to Evidence Packet
                        </div>
                        
                        <div class="vision-why-helps">
                            üí° Why this helps: Visual context helps responders validate environment risk when voice is limited or ambiguous.
                        </div>
                    </div>
                    
                    <p style="margin-bottom: 12px; color: #666; font-size: 14px;">
                        Google Gemini 1.5 Pro will analyze the situation for emergency indicators.
                    </p>
                    <button class="btn btn-primary" id="btn-analyze" onclick="analyzeWithGemini()">
                        Analyze with Gemini
                    </button>
                </div>
            </div>

            <!-- Step 5: Emergency Alerting -->
            <div class="step" id="step5">
                <div class="step-header">
                    <div class="step-title">Step 5: Emergency Alerting</div>
                    <div class="step-status">Pending</div>
                </div>
                <div class="step-content">
                    <p style="color: #666; font-size: 14px;">
                        Alerts will be sent based on Gemini's risk assessment.
                    </p>
                </div>
            </div>
        </div>

        <!-- Analysis Result -->
        <div class="analysis-result" id="analysis-result">
            <h2>Gemini Analysis Result</h2>
            <div id="result-content"></div>
            
            <div class="architecture-note">
                <h3>Architecture: ERNIE ‚Üí Gemini Parity</h3>
                <p>
                    <strong>This system demonstrates architectural parity between ERNIE and Gemini.</strong>
                    The same 5-step pipeline (Identity ‚Üí Location ‚Üí Voice ‚Üí AI Analysis ‚Üí Alerting) works identically with both providers.
                    Gemini 1.5 Pro replaces ERNIE as the intelligence layer while preserving all safety guarantees, fallback mechanisms, and runtime diagnostics.
                    Deployed on AWS CloudFront + Lambda for production-grade reliability and HTTPS GPS access.
                </p>
            </div>

            <div class="console-log" id="console-log"></div>
        </div>
    </div>

    <script>
        // Configuration - Lambda Function URL will be injected during deployment
        const LAMBDA_FUNCTION_URL = '{{LAMBDA_FUNCTION_URL}}';

        // Runtime state
        const RUNTIME = {
            geminiAvailable: false,
            modelName: 'gemini-1.5-pro',
            sdkLoaded: false,
            mode: 'CLOUDFRONT',
            logs: []
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            log('System initializing...', 'info');
            log(`Lambda Function URL: ${LAMBDA_FUNCTION_URL}`, 'info');
            checkGeminiRuntime();
        });

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const entry = `[${timestamp}] ${message}`;
            RUNTIME.logs.push({ message: entry, type });
            
            console.log(`[GEMINI-CLOUDFRONT] ${message}`);
            updateConsoleLog();
        }

        function updateConsoleLog() {
            const consoleEl = document.getElementById('console-log');
            if (!consoleEl) return;
            
            consoleEl.innerHTML = RUNTIME.logs.map(log => 
                `<div class="log-entry log-${log.type}">${log.message}</div>`
            ).join('');
            
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function checkGeminiRuntime() {
            log('Checking Gemini runtime via Lambda...', 'info');
            
            fetch(`${LAMBDA_FUNCTION_URL}/health`)
                .then(response => response.json())
                .then(data => {
                    RUNTIME.sdkLoaded = data.sdk_loaded;
                    RUNTIME.geminiAvailable = data.gemini_available;
                    RUNTIME.mode = data.mode;
                    RUNTIME.modelName = data.model_name;
                    
                    updateHealthPanel();
                    
                    if (RUNTIME.geminiAvailable) {
                        log('Gemini SDK detected and initialized', 'success');
                        log(`Model: ${RUNTIME.modelName}`, 'info');
                    } else {
                        log('Gemini API not available - using fallback mode', 'warning');
                        log('Lambda will use keyword matching for demo', 'info');
                    }
                })
                .catch(error => {
                    log(`Lambda health check failed: ${error.message}`, 'error');
                    log('Using mock mode for demo', 'warning');
                    
                    RUNTIME.sdkLoaded = false;
                    RUNTIME.geminiAvailable = false;
                    RUNTIME.mode = 'MOCK';
                    
                    updateHealthPanel();
                });
        }

        function updateHealthPanel() {
            // Gemini Status
            const statusEl = document.getElementById('health-gemini-status');
            statusEl.className = 'health-item ' + (RUNTIME.geminiAvailable ? 'live' : 'fallback');
            statusEl.querySelector('.health-value').textContent = RUNTIME.geminiAvailable ? 'LIVE' : 'FALLBACK';
            
            // Model
            const modelEl = document.getElementById('health-model');
            modelEl.className = 'health-item live';
            modelEl.querySelector('.health-value').textContent = RUNTIME.modelName;
            
            // SDK
            const sdkEl = document.getElementById('health-sdk');
            sdkEl.className = 'health-item ' + (RUNTIME.sdkLoaded ? 'live' : 'fallback');
            sdkEl.querySelector('.health-value').textContent = RUNTIME.sdkLoaded ? 'Yes' : 'No';
            
            // Mode
            const modeEl = document.getElementById('health-mode');
            modeEl.className = 'health-item ' + (RUNTIME.mode === 'LIVE' ? 'live' : 'fallback');
            modeEl.querySelector('.health-value').textContent = RUNTIME.mode;
            
            // Backend
            const backendEl = document.getElementById('health-backend');
            backendEl.className = 'health-item live';
            
            // Deployment
            const deploymentEl = document.getElementById('health-deployment');
            deploymentEl.className = 'health-item live';
        }

        async function analyzeWithGemini() {
            const btn = document.getElementById('btn-analyze');
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            
            log('Starting Gemini analysis...', 'info');
            
            const transcript = document.getElementById('input-transcript').value;
            const location = document.getElementById('input-location').value;
            const name = document.getElementById('input-name').value;
            const contact = document.getElementById('input-contact').value;
            
            // Trigger vision analysis (demo mode)
            if (visionController) {
                log('Triggering vision analysis...', 'info');
                visionController.activateOnEmergency('emergency', transcript);
            }
            
            try {
                log('Calling Lambda Function URL...', 'info');
                const response = await fetch(`${LAMBDA_FUNCTION_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transcript,
                        location,
                        name,
                        contact
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Lambda returned ${response.status}`);
                }
                
                const result = await response.json();
                log(`Lambda response: ${result.mode} mode`, 'info');
                log(`Analysis complete: ${result.risk_level} (confidence: ${result.confidence})`, 'success');
                
                displayResult(result);
                
                // Update steps
                document.getElementById('step4').classList.add('complete');
                document.getElementById('step4').classList.remove('active');
                document.getElementById('step4').querySelector('.step-status').textContent = 'Complete';
                
                if (result.risk_level === 'HIGH' || result.risk_level === 'CRITICAL') {
                    document.getElementById('step5').classList.add('active');
                    document.getElementById('step5').querySelector('.step-status').textContent = 'Alerting';
                    log('Emergency alert triggered', 'warning');
                }
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                log('Using fallback response for safety', 'warning');
                
                const fallbackResult = {
                    risk_level: 'MEDIUM',
                    confidence: 0.0,
                    reasoning: 'Analysis unavailable. Using fallback response for safety.',
                    indicators: ['API_ERROR'],
                    recommended_action: 'MONITOR',
                    response_time: 0,
                    mode: 'FALLBACK'
                };
                
                displayResult(fallbackResult);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyze Again';
            }
        }

        function displayResult(result) {
            const resultDiv = document.getElementById('analysis-result');
            const contentDiv = document.getElementById('result-content');
            
            const riskClass = `risk-${result.risk_level.toLowerCase()}`;
            
            contentDiv.innerHTML = `
                <div class="risk-badge ${riskClass}">
                    Risk Level: ${result.risk_level}
                </div>
                <p><strong>Confidence:</strong> ${(result.confidence * 100).toFixed(0)}%</p>
                <p><strong>Mode:</strong> ${result.mode}</p>
                <p><strong>Response Time:</strong> ${result.response_time}s</p>
                <p><strong>Recommended Action:</strong> ${result.recommended_action}</p>
                <p><strong>Reasoning:</strong> ${result.reasoning}</p>
                <p><strong>Indicators:</strong> ${result.indicators.join(', ')}</p>
            `;
            
            resultDiv.classList.add('show');
        }
        
        // ========== VISION CONTEXT ANALYSIS ==========
        
        /**
         * VisionContextController - Manages vision analysis state and workflow
         */
        class VisionContextController {
            constructor() {
                this.status = 'standby';  // standby | capturing | analyzing | complete | error
                this.triggerReason = null;
                this.frames = [];
                this.findings = [];
                this.confidence = null;
                this.isDemoMode = true;  // MVP uses demo mode only
            }
            
            /**
             * Activate vision analysis on emergency trigger
             */
            async activateOnEmergency(keyword, transcript) {
                console.log('[VISION] Activating on emergency:', keyword);
                
                this.status = 'capturing';
                this.triggerReason = `Emergency trigger detected ('${keyword}')`;
                
                // Update UI to activation state
                this.renderActivationState();
                
                // Simulate capture and analysis
                await this.simulateCaptureAndAnalysis(transcript);
            }
            
            /**
             * Simulate capture and analysis (Demo Mode)
             */
            async simulateCaptureAndAnalysis(transcript) {
                // Step 1: Trigger received
                document.getElementById('progressTrigger').textContent = '‚úÖ';
                await this.delay(500);
                
                // Step 2: Capturing frames
                this.status = 'capturing';
                this.updateStatusBadge('capturing', 'Capturing‚Ä¶');
                document.getElementById('progressCapture').textContent = '‚è≥';
                await this.delay(1000);
                
                // Generate demo frames
                this.frames = this.generateDemoFrames(2);
                document.getElementById('progressCapture').textContent = '‚úÖ';
                
                // Step 3: Analyzing
                this.status = 'analyzing';
                this.updateStatusBadge('analyzing', 'Analyzing‚Ä¶');
                document.getElementById('progressAnalyze').textContent = '‚è≥';
                await this.delay(1500);
                
                // Generate demo findings
                this.findings = this.generateDemoFindings(transcript);
                this.confidence = this.calculateConfidence(transcript);
                document.getElementById('progressAnalyze').textContent = '‚úÖ';
                
                // Step 4: Publishing
                document.getElementById('progressPublish').textContent = '‚è≥';
                await this.delay(500);
                document.getElementById('progressPublish').textContent = '‚úÖ';
                
                // Complete
                this.status = 'complete';
                this.renderCompletedState();
                
                console.log('[VISION] Analysis complete:', {
                    frames: this.frames.length,
                    findings: this.findings.length,
                    confidence: this.confidence
                });
            }
            
            /**
             * Generate demo frames (simulated images)
             */
            generateDemoFrames(count) {
                const frames = [];
                for (let i = 0; i < count; i++) {
                    // Create placeholder canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = 320;
                    canvas.height = 240;
                    const ctx = canvas.getContext('2d');
                    
                    // Draw gradient background
                    const gradient = ctx.createLinearGradient(0, 0, 320, 240);
                    gradient.addColorStop(0, '#667eea');
                    gradient.addColorStop(1, '#764ba2');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, 320, 240);
                    
                    // Add text
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Demo Frame ${i + 1}`, 160, 120);
                    ctx.font = '14px Arial';
                    ctx.fillText('(Simulated)', 160, 145);
                    
                    frames.push(canvas.toDataURL('image/jpeg', 0.8));
                }
                return frames;
            }
            
            /**
             * Generate demo findings based on transcript
             */
            generateDemoFindings(transcript) {
                const findings = [];
                const lowerTranscript = transcript.toLowerCase();
                
                // Analyze transcript for context clues
                if (lowerTranscript.includes('following') || lowerTranscript.includes('stalking')) {
                    findings.push('Multiple individuals detected nearby');
                    findings.push('Low visibility conditions');
                }
                
                if (lowerTranscript.includes('scared') || lowerTranscript.includes('afraid')) {
                    findings.push('Confined indoor environment');
                }
                
                if (lowerTranscript.includes('help') || lowerTranscript.includes('emergency')) {
                    findings.push('Isolated location detected');
                }
                
                // Always add at least one finding
                if (findings.length === 0) {
                    findings.push('Environmental risk indicators present');
                }
                
                return findings;
            }
            
            /**
             * Calculate confidence based on transcript
             */
            calculateConfidence(transcript) {
                const lowerTranscript = transcript.toLowerCase();
                let score = 0;
                
                if (lowerTranscript.includes('help')) score += 0.3;
                if (lowerTranscript.includes('scared') || lowerTranscript.includes('afraid')) score += 0.3;
                if (lowerTranscript.includes('following')) score += 0.2;
                if (lowerTranscript.includes('emergency')) score += 0.2;
                
                if (score >= 0.7) return 'high';
                if (score >= 0.4) return 'medium';
                return 'low';
            }
            
            /**
             * Render activation state UI
             */
            renderActivationState() {
                // Update status badge
                this.updateStatusBadge('capturing', 'Capturing‚Ä¶');
                
                // Hide standby elements
                document.getElementById('visionExplainer').style.display = 'none';
                document.getElementById('visionFramesPlaceholder').style.display = 'none';
                
                // Update placeholders to show capturing status
                const placeholders = document.getElementById('visionPlaceholders');
                placeholders.innerHTML = `
                    <p><strong>Findings:</strong> Analyzing...</p>
                    <p><strong>Confidence:</strong> ‚Äî</p>
                    <p><strong>Vision/Video Status:</strong> Capturing frames...</p>
                `;
                
                // Show trigger reason
                const triggerReasonDiv = document.getElementById('visionTriggerReason');
                const triggerText = document.getElementById('visionTriggerText');
                triggerReasonDiv.style.display = 'block';
                triggerText.textContent = this.triggerReason;
                
                // Show progress indicators
                document.getElementById('visionProgress').style.display = 'block';
            }
            
            /**
             * Render completed state UI
             */
            renderCompletedState() {
                // Update status badge
                this.updateStatusBadge('complete', 'Complete');
                
                // Hide progress
                document.getElementById('visionProgress').style.display = 'none';
                
                // Update placeholders to show completed status
                const placeholders = document.getElementById('visionPlaceholders');
                placeholders.innerHTML = `
                    <p><strong>Findings:</strong> ${this.findings.length} indicators detected</p>
                    <p><strong>Confidence:</strong> ${this.confidence.charAt(0).toUpperCase() + this.confidence.slice(1)}</p>
                    <p><strong>Vision/Video Status:</strong> Findings recorded (${this.frames.length} frames, confidence: ${this.confidence})</p>
                `;
                
                // Show thumbnails
                const thumbnailsDiv = document.getElementById('visionThumbnails');
                thumbnailsDiv.innerHTML = '';
                this.frames.forEach((frame, index) => {
                    const img = document.createElement('img');
                    img.src = frame;
                    img.className = 'vision-thumbnail blurred';
                    img.alt = `Frame ${index + 1}`;
                    thumbnailsDiv.appendChild(img);
                });
                
                // Add toggle button
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'vision-thumbnail-toggle';
                toggleBtn.textContent = 'Tap to view';
                toggleBtn.onclick = () => this.toggleBlur();
                thumbnailsDiv.appendChild(toggleBtn);
                thumbnailsDiv.style.display = 'flex';
                
                // Show findings
                const findingsDiv = document.getElementById('visionFindings');
                const findingsList = document.getElementById('visionFindingsList');
                findingsList.innerHTML = '';
                this.findings.forEach(finding => {
                    const li = document.createElement('li');
                    li.textContent = finding;
                    findingsList.appendChild(li);
                });
                findingsDiv.style.display = 'block';
                
                // Show confidence
                const confidenceDiv = document.getElementById('visionConfidence');
                const confidenceBadge = document.getElementById('visionConfidenceBadge');
                confidenceBadge.textContent = this.confidence.charAt(0).toUpperCase() + this.confidence.slice(1);
                confidenceBadge.className = `badge ${this.confidence}`;
                confidenceDiv.style.display = 'block';
                
                // Show evidence indicator
                document.getElementById('visionEvidenceIndicator').style.display = 'block';
            }
            
            /**
             * Update status badge
             */
            updateStatusBadge(status, text) {
                const badge = document.getElementById('visionStatusBadge');
                badge.className = `vision-status-badge ${status}`;
                badge.querySelector('span').textContent = text;
            }
            
            /**
             * Toggle blur on thumbnails
             */
            toggleBlur() {
                const thumbnails = document.querySelectorAll('.vision-thumbnail');
                thumbnails.forEach(img => {
                    img.classList.toggle('blurred');
                });
                
                const btn = document.querySelector('.vision-thumbnail-toggle');
                if (btn) {
                    btn.textContent = thumbnails[0].classList.contains('blurred') ? 'Tap to view' : 'Blur images';
                }
            }
            
            /**
             * Reset to standby state
             */
            reset() {
                this.status = 'standby';
                this.triggerReason = null;
                this.frames = [];
                this.findings = [];
                this.confidence = null;
                
                // Reset UI
                this.updateStatusBadge('standby', 'Standby');
                
                // Show standby elements
                document.getElementById('visionExplainer').style.display = 'block';
                document.getElementById('visionFramesPlaceholder').style.display = 'block';
                
                // Reset placeholders
                const placeholders = document.getElementById('visionPlaceholders');
                placeholders.innerHTML = `
                    <p><strong>Findings:</strong> ‚Äî</p>
                    <p><strong>Confidence:</strong> ‚Äî</p>
                    <p><strong>Vision/Video Status:</strong> Standby</p>
                `;
                
                // Hide other elements
                document.getElementById('visionTriggerReason').style.display = 'none';
                document.getElementById('visionProgress').style.display = 'none';
                document.getElementById('visionThumbnails').style.display = 'none';
                document.getElementById('visionFindings').style.display = 'none';
                document.getElementById('visionConfidence').style.display = 'none';
                document.getElementById('visionEvidenceIndicator').style.display = 'none';
                
                console.log('[VISION] Reset to standby');
            }
            
            /**
             * Delay helper
             */
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // Initialize vision controller
        let visionController = null;
        
        window.addEventListener('DOMContentLoaded', () => {
            visionController = new VisionContextController();
            log('Vision Context Controller initialized', 'info');
        });
    </script>
</body>
</html>
