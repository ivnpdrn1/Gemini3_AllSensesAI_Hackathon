<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllSensesAI Gemini3 Guardian</title>
    
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { background: rgba(255,255,255,0.95); padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #7f8c8d; font-size: 1.2em; }
        .section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .section h3 { color: #2c3e50; margin-bottom: 15px; }
        .button { background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; margin: 5px; }
        .button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52,152,219,0.4); }
        .button.emergency { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .button.emergency:hover { box-shadow: 0 5px 15px rgba(231,76,60,0.4); }
        .button.primary-btn { background: linear-gradient(45deg, #28a745, #20c997); }
        .button.secondary-btn { background: linear-gradient(45deg, #6c757d, #495057); }
        .button.danger-btn { background: linear-gradient(45deg, #dc3545, #c82333); }
        .button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .controls-row { margin: 15px 0; text-align: center; }
        .controls-row .button { margin: 5px 10px; }
        textarea { width: 100%; height: 120px; margin: 10px 0; padding: 15px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em; }
        input[type="text"], input[type="tel"] { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em; }
        .result { background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #27ae60; }
        .error { background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #f39c12; }
        .note { font-size: 0.9em; color: #666; margin-top: 8px; }
        .location-status { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #28a745; }
        .location-status.denied { border-left-color: #dc3545; background: #f8d7da; }
        .location-status.unavailable { border-left-color: #ffc107; background: #fff3cd; }
        
        .runtime-health { background: #fff; border: 2px solid #007bff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .runtime-health h3 { color: #007bff; margin-bottom: 10px; font-size: 1.2em; }
        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .health-item { background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745; }
        .health-item.warning { border-left-color: #ffc107; background: #fff3cd; }
        .health-item.error { border-left-color: #dc3545; background: #f8d7da; }
        .health-label { font-size: 0.85em; color: #666; margin-bottom: 4px; }
        .health-value { font-weight: bold; color: #2c3e50; }
        
        /* NEW: Selected Location Panel */
        .selected-location-panel { background: #e8f5e9; border: 2px solid #4caf50; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .selected-location-panel h4 { margin: 0 0 10px 0; color: #2e7d32; font-size: 1.1em; }
        .location-detail { display: grid; grid-template-columns: 140px 1fr; gap: 8px; margin: 5px 0; font-size: 0.95em; }
        .location-label { font-weight: bold; color: #555; }
        .location-value { color: #2c3e50; font-family: monospace; }
        
        /* NEW: Microphone Status Badge */
        .mic-status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .mic-status-badge.idle { background: #e9ecef; color: #6c757d; }
        .mic-status-badge.requesting { background: #fff3cd; color: #856404; }
        .mic-status-badge.listening { background: #d4edda; color: #155724; animation: pulse 1.5s infinite; }
        .mic-status-badge.stopped { background: #f8d7da; color: #721c24; }
        .mic-status-badge.error { background: #f8d7da; color: #721c24; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* NEW: Live Transcript Box */
        .transcript-box { background: #fff; border: 2px solid #007bff; padding: 15px; border-radius: 8px; margin: 15px 0; min-height: 120px; max-height: 300px; overflow-y: auto; }
        .transcript-box h4 { margin: 0 0 10px 0; color: #007bff; font-size: 1em; }
        .transcript-content { font-family: monospace; font-size: 0.9em; color: #495057; white-space: pre-wrap; line-height: 1.6; }
        .transcript-line { margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 4px; }
        .transcript-timestamp { color: #6c757d; font-size: 0.85em; margin-right: 8px; }
        .transcript-interim { color: #6c757d; font-style: italic; }
        .listening-indicator { color: #28a745; font-style: italic; }
        
        /* NEW: Voice Controls */
        .voice-controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 15px 0; }
        
        /* NEW: Emergency Banner */
        .emergency-banner { background: linear-gradient(45deg, #dc3545, #c82333); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 3px solid #a71d2a; box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4); animation: emergencyPulse 2s infinite; display: none; }
        .emergency-banner h2 { margin: 0 0 10px 0; font-size: 1.8em; }
        .emergency-banner .emergency-details { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 10px; }
        .emergency-banner .emergency-detail-row { display: grid; grid-template-columns: 150px 1fr; gap: 10px; margin: 8px 0; font-size: 0.95em; }
        .emergency-banner .detail-label { font-weight: bold; }
        .emergency-banner .detail-value { font-family: monospace; }
        .emergency-banner .maps-link { display: inline-block; background: #fff; color: #dc3545; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 10px; }
        .emergency-banner .maps-link:hover { background: #f8f9fa; }
        
        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4); }
            50% { box-shadow: 0 5px 30px rgba(220, 53, 69, 0.8); }
        }
        
        /* NEW: Emergency Modal */
        .emergency-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .emergency-modal-content { background: white; padding: 40px; border-radius: 15px; max-width: 500px; text-align: center; box-shadow: 0 10px 50px rgba(0,0,0,0.5); animation: modalSlideIn 0.3s ease-out; }
        .emergency-modal h2 { color: #dc3545; font-size: 2em; margin-bottom: 15px; }
        .emergency-modal p { font-size: 1.1em; color: #495057; margin: 10px 0; }
        .emergency-modal .modal-button { background: linear-gradient(45deg, #dc3545, #c82333); color: white; padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; margin-top: 20px; }
        .emergency-modal .modal-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4); }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* NEW: Emergency Badge for Step 3 */
        .mic-status-badge.emergency-detected { background: #dc3545; color: white; animation: badgePulse 1s infinite; }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    
        /* NEW: Emergency Keywords Configuration UI */
        .keywords-config { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .keywords-config h4 { margin: 0 0 10px 0; color: #856404; font-size: 1em; }
        .keywords-config-description { font-size: 0.9em; color: #856404; margin-bottom: 10px; }
        .keywords-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; min-height: 40px; }
        .keyword-chip { background: #fff; border: 2px solid #ffc107; padding: 6px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9em; }
        .keyword-chip-text { color: #856404; font-weight: 500; }
        .keyword-chip-remove { background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 0.8em; line-height: 1; padding: 0; }
        .keyword-chip-remove:hover { background: #c82333; }
        .keyword-input-row { display: flex; gap: 10px; margin-top: 10px; }
        .keyword-input { flex: 1; padding: 8px 12px; border: 2px solid #ffc107; border-radius: 8px; font-size: 0.9em; }
        .keyword-add-btn { background: #28a745; color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: bold; }
        .keyword-add-btn:hover { background: #218838; }
        .keyword-add-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .keywords-help { font-size: 0.85em; color: #856404; margin-top: 8px; font-style: italic; }
        
        /* NEW: Reset Emergency Button */
        .reset-emergency-btn { background: linear-gradient(45deg, #6c757d, #495057); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; margin: 10px 5px; }
        .reset-emergency-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4); }
        .reset-emergency-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
    
        /* SMS Preview Panel */
        .sms-preview-panel { background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 10px; margin: 15px 0; }
        .sms-preview-panel h4 { margin: 0 0 10px 0; color: #856404; font-size: 1.1em; }
        .sms-preview-description { font-size: 0.9em; color: #856404; margin-bottom: 15px; }
        .sms-preview-fields { background: #fff; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .sms-field { display: grid; grid-template-columns: 150px 1fr; gap: 10px; margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 0.95em; }
        .sms-field-label { font-weight: bold; color: #495057; }
        .sms-field-value { color: #212529; font-family: monospace; }
        .sms-text-preview { background: #fff; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .sms-text-preview h5 { margin: 0 0 10px 0; color: #495057; font-size: 1em; }
        .sms-text-content { background: #f8f9fa; padding: 12px; border-radius: 5px; font-family: monospace; font-size: 0.9em; color: #212529; white-space: pre-wrap; min-height: 80px; border: 1px solid #dee2e6; }

    
        /* Vision Context Analysis Panel */
        .vision-context-panel { background: #f0f8ff; border: 2px solid #4a90e2; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .vision-context-panel h4 { margin: 0 0 15px 0; color: #2c5aa0; font-size: 1.2em; }
        .vision-status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-bottom: 15px; }
        .vision-status-badge.standby { background: #e9ecef; color: #6c757d; }
        .vision-status-badge.capturing { background: #fff3cd; color: #856404; animation: visionPulse 1.5s infinite; }
        .vision-status-badge.analyzing { background: #cfe2ff; color: #084298; animation: visionPulse 1.5s infinite; }
        .vision-status-badge.complete { background: #d1e7dd; color: #0f5132; }
        .vision-status-badge.error { background: #f8d7da; color: #842029; }
        .vision-explainer { background: #fff; padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 0.95em; color: #495057; border-left: 4px solid #4a90e2; }
        .vision-placeholders { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0; color: #adb5bd; font-style: italic; }
        .vision-placeholders p { margin: 5px 0; }
        .vision-frames-placeholder { margin: 15px 0; }
        .frame-placeholder { display: inline-block; margin: 5px; }
        .vision-thumbnails { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
        .vision-thumbnail { width: 120px; height: 90px; border-radius: 6px; object-fit: cover; border: 2px solid #dee2e6; }
        .vision-thumbnail.blurred { filter: blur(8px); }
        .vision-thumbnail-toggle { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-top: 8px; }
        .vision-thumbnail-toggle:hover { background: #5a6268; }
        .vision-findings { background: #fff; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .vision-findings ul { margin: 10px 0; padding-left: 20px; }
        .vision-findings li { margin: 6px 0; color: #495057; }
        .vision-confidence { background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0; display: inline-block; }
        .vision-confidence .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: bold; margin-left: 8px; }
        .vision-confidence .badge.low { background: #d1e7dd; color: #0f5132; }
        .vision-confidence .badge.medium { background: #fff3cd; color: #856404; }
        .vision-confidence .badge.high { background: #f8d7da; color: #842029; }
        .vision-evidence-indicator { background: #d1e7dd; padding: 10px 15px; border-radius: 6px; margin: 10px 0; color: #0f5132; font-weight: 500; border-left: 4px solid #198754; }
        .vision-why-helps { font-size: 0.85em; color: #6c757d; margin-top: 10px; font-style: italic; }
        
        @keyframes visionPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- NEW: Emergency Banner (Hidden by default) -->
        <div id="emergencyBanner" class="emergency-banner">
            <h2>üö® EMERGENCY TRIGGERED</h2>
            <div class="emergency-details">
                <div class="emergency-detail-row">
                    <span class="detail-label">Timestamp:</span>
                    <span class="detail-value" id="emergency-timestamp">‚Äî</span>
                </div>
                <div class="emergency-detail-row">
                    <span class="detail-label">Detected Phrase:</span>
                    <span class="detail-value" id="emergency-phrase">‚Äî</span>
                </div>
                <div class="emergency-detail-row">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value" id="emergency-location">‚Äî</span>
                </div>
                <div class="emergency-detail-row">
                    <span class="detail-label">Coordinates:</span>
                    <span class="detail-value" id="emergency-coords">‚Äî</span>
                </div>
                <a id="emergencyMapsLink" href="#" target="_blank" rel="noopener noreferrer" class="maps-link">
                    üó∫Ô∏è View Emergency Location on Google Maps
                </a>
            </div>
        </div>
        
        <!-- NEW: Emergency Modal (Hidden by default) -->
        <div id="emergencyModal" class="emergency-modal">
            <div class="emergency-modal-content">
                <h2>üö® Emergency Detected</h2>
                <p><strong>Escalation sequence started</strong></p>
                <p>Locking in live location updates</p>
                <p id="modalDetectedPhrase" style="font-style: italic; color: #dc3545; margin-top: 15px;"></p>
                <button class="modal-button" onclick="closeEmergencyModal()">Proceed to Threat Analysis</button>
            </div>
        </div>
        
        <div class="header">
            <h1>AllSensesAI Gemini3 Guardian</h1>
            <p>Gemini 1.5 Pro | Emergency Detection System</p>
            <div id="buildStamp" style="font-size:14px;color:#fff;margin-top:8px;font-weight:bold;background:#4285f4;padding:6px 12px;border-radius:6px;">Build: GEMINI3-GUARDIAN-SMS-VIDEO-20260131-v2</div>
            
            <div style="background:#e8f5e9;border:1px solid #4caf50;padding:8px 12px;border-radius:5px;margin:8px 0;font-size:13px;color:#2e7d32;">
                <strong>GEMINI3 POWERED:</strong> Using Google Gemini 1.5 Pro for threat analysis
            </div>
        </div>
        
        <div class="runtime-health">
            <h3>üîç Runtime Health Check</h3>
            <div class="health-grid">
                <div class="health-item" id="health-gemini3">
                    <div class="health-label">Gemini3 Client</div>
                    <div class="health-value" id="gemini3-status">Initializing...</div>
                </div>
                <div class="health-item" id="health-model">
                    <div class="health-label">Model</div>
                    <div class="health-value">gemini-1.5-pro</div>
                </div>
                <div class="health-item" id="health-pipeline">
                    <div class="health-label">Pipeline State</div>
                    <div class="health-value" id="pipeline-state">IDLE</div>
                </div>
                <div class="health-item" id="health-location">
                    <div class="health-label">Location Services</div>
                    <div class="health-value" id="location-health">Not Started</div>
                </div>
                <div class="health-item live" id="health-loaded-build">
                    <div class="health-label">Loaded Build ID</div>
                    <div class="health-value" style="font-family: monospace; font-size: 12px;">GEMINI3-GUARDIAN-SMS-VIDEO-VIDEO-20260129-v3</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>üë§ Step 1 ‚Äî Configuration</h3>
            <p class="note" style="margin-bottom: 10px;">Enter your name and emergency contact phone number. This information will be used if an emergency is detected.</p>
            <input type="text" id="victimName" placeholder="Your Name" value="Demo User">
            <input type="tel" id="emergencyPhone" placeholder="+1234567890" value="+1234567890">
            <button type="button" class="button primary-btn" onclick="completeStep1()">‚úÖ Complete Step 1</button>
            <div id="step1Status" class="note">Enter your details and click Complete Step 1</div>
        </div>
        
        <div class="section">
            <h3>üìç Step 2 ‚Äî Location Services</h3>
            
            <p class="note" style="margin-bottom: 10px;">Enable location services to capture your exact coordinates in case of emergency. Your location will be shared with emergency contacts and responders.</p>
            
            <div id="locationStatus" class="location-status">
                <strong>GPS Status:</strong> <span id="gpsStatus">üìç Click Enable Location to start</span><br>
                <strong>Last Update:</strong> <span id="lastGpsUpdate">Never</span><br>
                <strong>Accuracy:</strong> <span id="gpsAccuracy">Unknown</span>
            </div>
            
            <!-- NEW: Selected Location Panel -->
            <div id="selectedLocationPanel" class="selected-location-panel" style="display:none;">
                <h4>üìç Selected Location</h4>
                <div class="location-detail">
                    <span class="location-label">Latitude:</span>
                    <span class="location-value" id="loc-latitude">‚Äî</span>
                </div>
                <div class="location-detail">
                    <span class="location-label">Longitude:</span>
                    <span class="location-value" id="loc-longitude">‚Äî</span>
                </div>
                <div class="location-detail">
                    <span class="location-label">Source:</span>
                    <span class="location-value" id="loc-source">‚Äî</span>
                </div>
                <div class="location-detail">
                    <span class="location-label">Timestamp:</span>
                    <span class="location-value" id="loc-timestamp">‚Äî</span>
                </div>
                <div class="location-detail">
                    <span class="location-label">Location Label:</span>
                    <span class="location-value" id="loc-label">‚Äî</span>
                </div>
                <!-- NEW: Google Maps Live Location Link -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4caf50;">
                    <a id="googleMapsLink" href="#" target="_blank" rel="noopener noreferrer" style="display: inline-block; background: linear-gradient(45deg, #4285f4, #34a853); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 0.95em;">
                        üó∫Ô∏è View Live Location on Google Maps
                    </a>
                    <div style="font-size: 0.85em; color: #666; margin-top: 8px;">
                        Opens in new tab ‚Ä¢ Updates automatically with latest position
                    </div>
                </div>
            </div>
            
            <div class="controls-row">
                <button type="button" id="enableLocationBtn" class="button primary-btn" disabled>üìç Enable Location</button>
                <button type="button" id="demoLocationBtn" class="button secondary-btn">üéØ Use Demo Location</button>
            </div>
            
            <div id="step2ProofBox" style="background: #f8f9fa; border: 2px solid #007bff; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 0.85em; min-height: 60px;">
                <strong>üîç Step 2 Proof (UI-Visible):</strong><br>
                <div id="step2ProofLog" style="color: #495057; white-space: pre-wrap;">Complete Step 1, then click "Enable Location" to see proof logs appear here...</div>
            </div>
            
            <div class="note">This proof box shows exactly what happens when you click Enable Location</div>
        </div>
        
        <div class="section">
            <h3>
                üé§ Step 3 ‚Äî Voice Emergency Detection
                <span id="micStatusBadge" class="mic-status-badge idle">Idle</span>
            </h3>
            
            <!-- NEW: Emergency Keywords Configuration -->
            <div class="keywords-config">
                <h4>‚öôÔ∏è Emergency Keywords Configuration</h4>
                <div class="keywords-config-description">
                    These words/phrases will trigger emergency detection when spoken. Customize them for your needs.
                </div>
                <div class="keywords-list" id="keywordsList">
                    <!-- Keywords will be rendered here -->
                </div>
                <div class="keyword-input-row">
                    <input type="text" id="keywordInput" class="keyword-input" placeholder="Enter new emergency keyword or phrase..." maxlength="50">
                    <button id="addKeywordBtn" class="keyword-add-btn" onclick="addKeyword()">‚ûï Add Keyword</button>
                </div>
                <div class="keywords-help">
                    üí° Examples: "emergency", "help me", "call 911", "I'm in danger". Press Enter to add quickly.
                </div>
            </div>

            
            <p class="note" style="margin-bottom: 10px;">Start voice detection to monitor for emergency keywords. When detected, the system will automatically analyze the threat and alert your emergency contacts.</p>
            <!-- NEW: Voice Controls -->
            <div class="voice-controls">
                <button id="startVoiceBtn" class="button primary-btn" disabled>üé§ Start Voice Detection</button>
                <button id="stopVoiceBtn" class="button danger-btn" style="display:none;">‚èπÔ∏è Stop Listening</button>
                <button id="clearTranscriptBtn" class="button secondary-btn" style="display:none;">üóëÔ∏è Clear Transcript</button>
                <button id="resetEmergencyBtn" class="reset-emergency-btn" style="display:none;" onclick="resetEmergencyState()">üîÑ Reset Emergency State</button>
            </div>
            
            <div id="voiceStatus" class="note">Complete Steps 1 & 2 to enable voice detection</div>
            
            <!-- NEW: Live Transcript Box -->
            <div id="transcriptBox" class="transcript-box" style="display:none;">
                <h4>üìù Live Transcript</h4>
                <div id="transcriptContent" class="transcript-content">
                    <div class="listening-indicator">(listening...)</div>
                </div>
            </div>
            
            <div id="step3ProofBox" style="background: #f8f9fa; border: 2px solid #007bff; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 0.85em; min-height: 40px; display:none;">
                <strong>üîç Step 3 Proof (Mic Events):</strong><br>
                <div id="step3ProofLog" style="color: #495057; white-space: pre-wrap;"></div>
            </div>
        </div>
        
        <div class="section">
            <h3>ü§ñ Step 4 ‚Äî Gemini3 Threat Analysis</h3>
            <!-- NEW: Visual Context Analysis Panel (Always Visible) -->
            <div id="visionContextPanel" class="vision-context-panel">
                <h4>üé• Visual Context (Gemini Vision) ‚Äî Video Frames</h4>
                
                <div id="visionStatusBadge" class="vision-status-badge standby">
                    <span>Standby</span>
                </div>
                
                <div id="visionExplainer" class="vision-explainer">
                    <p><strong>Standby:</strong> Activates automatically during detected risk to corroborate audio/text signals.</p>
                    <p><strong>Capture policy:</strong> Captures 1‚Äì3 video frames during emergency. No continuous recording.</p>
                </div>
                
                <!-- Video Frames Placeholders (Always Visible Before Trigger) -->
                <div id="visionFramesPlaceholder" class="vision-frames-placeholder">
                    <h5 style="margin: 10px 0; color: #6c757d; font-size: 1em;">üìπ Video Frames (Standby)</h5>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div class="frame-placeholder">
                            <div style="width: 120px; height: 90px; background: #e9ecef; border: 2px dashed #adb5bd; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 0.85em; text-align: center; padding: 5px;">
                                Frame 1<br>not captured
                            </div>
                        </div>
                        <div class="frame-placeholder">
                            <div style="width: 120px; height: 90px; background: #e9ecef; border: 2px dashed #adb5bd; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 0.85em; text-align: center; padding: 5px;">
                                Frame 2<br>not captured
                            </div>
                        </div>
                        <div class="frame-placeholder">
                            <div style="width: 120px; height: 90px; background: #e9ecef; border: 2px dashed #adb5bd; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 0.85em; text-align: center; padding: 5px;">
                                Frame 3<br>not captured
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="visionPlaceholders" class="vision-placeholders">
                    <p><strong>Findings:</strong> ‚Äî</p>
                    <p><strong>Confidence:</strong> ‚Äî</p>
                    <p><strong>Vision/Video Status:</strong> Standby</p>
                </div>
                
                <div id="visionTriggerReason" style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 0.95em; color: #856404; border-left: 4px solid #ffc107; display:none;">
                    <p><strong>Activated becaUse:</strong> <span id="visionTriggerText">‚Äî</span></p>
                </div>
                
                <div id="visionThumbnails" class="vision-thumbnails" style="display:none;">
                    <!-- Thumbnails will be inserted here -->
                </div>
                
                <div id="visionFindings" class="vision-findings" style="display:none;">
                    <strong>Environmental Risk Indicators:</strong>
                    <ul id="visionFindingsList">
                        <!-- Findings will be inserted here -->
                    </ul>
                </div>
                
                <div id="visionConfidence" class="vision-confidence" style="display:none;">
                    <strong>Confidence:</strong>
                    <span class="badge" id="visionConfidenceBadge">‚Äî</span>
                </div>
                
                <div id="visionEvidenceIndicator" class="vision-evidence-indicator" style="display:none;">
                    ‚úÖ Added to Evidence Packet
                </div>
                
                <div class="vision-why-helps">
                    üí° Why this helps: Visual context helps responders validate environment risk when voice is limited or ambiguous.
                </div>
            </div>
            

            <p class="note" style="margin-bottom: 10px;">Gemini 1.5 Pro analyzes the emergency transcript to assess threat level and recommend appropriate response actions.</p>
            <textarea id="audioInput" placeholder="Enter emergency text...">Help! Someone is following me and I'm scared!</textarea>
            <button class="button emergency" onclick="triggerGemini3Analysis()">ü§ñ Analyze with Gemini3</button>
            <div id="threatLevelOutput" style="margin-top:15px;padding:12px;background:#fff;border:2px solid #ddd;border-radius:5px;display:none;">
                <strong>Threat Level:</strong> <span id="threatLevel" style="font-size:1.2em;font-weight:bold;"></span><br>
                <strong>Confidence:</strong> <span id="threatConfidence"></span><br>
                <strong>Analysis:</strong> <span id="threatAnalysis"></span>
            </div>
            <div id="emergencyResult"></div>
        </div>
        
                <div class="section">
            <h3>üö® Step 5 ‚Äî Emergency Alerting</h3>
            <p class="note" style="margin-bottom: 10px;">When a high-risk threat is detected, emergency alerts are automatically sent to your emergency contact with your location and transcript details.</p>
            
            <!-- NEW: Always-Visible SMS Preview Structure -->
            <div id="smsPreviewPanel" class="sms-preview-panel">
                <h4>üì± SMS Alert Preview</h4>
                <div class="sms-preview-description">
                    This is the exact message that will be sent to your emergency contact when a threat is detected.
                </div>
                
                <div class="sms-preview-fields">
                    <div class="sms-field">
                        <span class="sms-field-label">Victim:</span>
                        <span class="sms-field-value" id="sms-victim">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Risk:</span>
                        <span class="sms-field-value" id="sms-risk">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Recommendation:</span>
                        <span class="sms-field-value" id="sms-recommendation">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Message:</span>
                        <span class="sms-field-value" id="sms-message">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Location:</span>
                        <span class="sms-field-value" id="sms-location">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Map:</span>
                        <span class="sms-field-value" id="sms-map">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Time:</span>
                        <span class="sms-field-value" id="sms-time">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Action:</span>
                        <span class="sms-field-value" id="sms-action">‚Äî</span>
                    </div>
                </div>
                
                <div class="sms-text-preview">
                    <h5>SMS Text Preview:</h5>
                    <div id="smsTextContent" class="sms-text-content">
                        (SMS message will appear here after threat analysis)
                    </div>
                </div>
            
            <!-- NEW: Enhanced SMS Delivery Proof Panel (v3) -->
            <div id="smsDeliveryProofPanel" class="sms-preview-panel" style="background: #e8f5e9; border-color: #4caf50; display:none;">
                <h4>üì° SMS Delivery Proof</h4>
                <div class="sms-preview-description">
                    Real-time delivery status with complete API response. No guessing - shows actual SNS publish result.
                </div>
                
                <div class="sms-preview-fields">
                    <div class="sms-field">
                        <span class="sms-field-label">Status:</span>
                        <span class="sms-field-value" id="sms-delivery-status" style="font-weight:bold;">NOT_SENT</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Provider:</span>
                        <span class="sms-field-value" id="sms-delivery-provider">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">SNS Message ID:</span>
                        <span class="sms-field-value" id="sms-delivery-message-id">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Request ID:</span>
                        <span class="sms-field-value" id="sms-delivery-request-id">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Destination:</span>
                        <span class="sms-field-value" id="sms-delivery-destination">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">HTTP Status:</span>
                        <span class="sms-field-value" id="sms-delivery-http-status">‚Äî</span>
                    </div>
                    <div class="sms-field">
                        <span class="sms-field-label">Timestamp:</span>
                        <span class="sms-field-value" id="sms-delivery-timestamp">‚Äî</span>
                    </div>
                </div>
                
                <div id="smsDeliveryError" style="background: #f8d7da; padding: 12px; border-radius: 5px; margin: 10px 0; display:none;">
                    <strong>‚ùå Delivery Failed:</strong><br>
                    <div style="margin-top: 8px;">
                        <strong>Error Code:</strong> <span id="smsDeliveryErrorCode">‚Äî</span><br>
                        <strong>Error Message:</strong> <span id="smsDeliveryErrorText">‚Äî</span>
                    </div>
                </div>
                
                <div id="smsDeliverySuccess" style="background: #d4edda; padding: 12px; border-radius: 5px; margin: 10px 0; display:none;">
                    <strong>‚úÖ SMS Delivered Successfully</strong><br>
                    <div style="margin-top: 8px; font-family: monospace; font-size: 0.9em;">
                        SNS MessageId: <span id="smsSuccessMessageId">‚Äî</span>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Manual Test SMS Button (v3 - NO RISK GATING) -->
            <div id="manualSmsTestSection" style="margin: 15px 0; display:none;">
                <button type="button" class="button secondary-btn" onclick="sendTestSms()">üì§ Send Test SMS</button>
                <div class="note">Test SMS delivery to your emergency contact. Works regardless of risk level (production safe).</div>
            </div>
            
</div>
            
            <div id="step5Status" class="note">Ready to send alert (complete Steps 1-4 first)</div>
            <div id="alertResult" style="display:none;margin-top:10px;padding:12px;background:#d4edda;border:1px solid #28a745;border-radius:5px;">
                <strong>‚úÖ Alert Sent!</strong><br>
                <span id="alertDetails"></span>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURABLE KEYWORDS CLASSES ==========
        
        /**
         * EmergencyKeywordsConfig - Manages emergency keyword configuration with localStorage persistence
         */
        class EmergencyKeywordsConfig {
            constructor() {
                this.storageKey = 'allsenses_emergency_keywords';
                this.defaultKeywords = ['emergency', 'help', 'call police', 'scared', 'following', 'danger', 'attack'];
                this.keywords = this.loadKeywords();
            }
            
            /**
             * Load keywords from localStorage or return defaults
             */
            loadKeywords() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            console.log('[KEYWORDS] Loaded from localStorage:', parsed);
                            return parsed;
                        }
                    }
                } catch (error) {
                    console.warn('[KEYWORDS] Error loading from localStorage:', error);
                }
                console.log('[KEYWORDS] Using default keywords');
                return [...this.defaultKeywords];
            }
            
            /**
             * Save keywords to localStorage
             */
            saveKeywords(keywords) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(keywords));
                    console.log('[KEYWORDS] Saved to localStorage:', keywords);
                } catch (error) {
                    console.error('[KEYWORDS] Error saving to localStorage:', error);
                    alert('Unable to save keywords. localStorage may be disabled.');
                }
            }
            
            /**
             * Add a new keyword
             */
            addKeyword(keyword) {
                const normalized = keyword.trim().toLowerCase();
                
                // Validation
                if (!normalized) {
                    alert('Keyword cannot be empty');
                    return false;
                }
                
                if (this.keywords.some(k => k.toLowerCase() === normalized)) {
                    alert('This keyword already exists');
                    return false;
                }
                
                this.keywords.push(keyword.trim());
                this.saveKeywords(this.keywords);
                console.log('[KEYWORDS] Added:', keyword.trim());
                return true;
            }
            
            /**
             * Remove a keyword
             */
            removeKeyword(keyword) {
                // Prevent removal of last keyword
                if (this.keywords.length <= 1) {
                    alert('You must have at least one emergency keyword configured');
                    return false;
                }
                
                this.keywords = this.keywords.filter(k => k !== keyword);
                this.saveKeywords(this.keywords);
                console.log('[KEYWORDS] Removed:', keyword);
                return true;
            }
            
            /**
             * Get current keywords
             */
            getKeywords() {
                return [...this.keywords];
            }
            
            /**
             * Render the configuration UI
             */
            renderUI(containerElement) {
                if (!containerElement) return;
                
                containerElement.innerHTML = '';
                
                this.keywords.forEach(keyword => {
                    const chip = document.createElement('div');
                    chip.className = 'keyword-chip';
                    
                    const text = document.createElement('span');
                    text.className = 'keyword-chip-text';
                    text.textContent = keyword;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'keyword-chip-remove';
                    removeBtn.textContent = '√ó';
                    removeBtn.title = `Remove "${keyword}"`;
                    removeBtn.onclick = () => {
                        if (this.removeKeyword(keyword)) {
                            this.renderUI(containerElement);
                        }
                    };
                    
                    chip.appendChild(text);
                    chip.appendChild(removeBtn);
                    containerElement.appendChild(chip);
                });
            }
        }
        
        /**
         * KeywordDetectionEngine - Analyzes transcripts for emergency keywords
         */
        class KeywordDetectionEngine {
            constructor(keywords) {
                this.keywords = keywords || [];
            }
            
            /**
             * Normalize text: lowercase, trim, collapse whitespace
             */
            normalizeText(text) {
                if (!text) return '';
                return text.toLowerCase().trim().replace(/\s+/g, ' ');
            }
            
            /**
             * Check if text contains any emergency keyword
             */
            detectKeyword(text) {
                const normalized = this.normalizeText(text);
                
                for (const keyword of this.keywords) {
                    const normalizedKeyword = this.normalizeText(keyword);
                    
                    // Check if keyword is a single word or multi-word phrase
                    const words = normalizedKeyword.split(' ');
                    
                    if (words.length === 1) {
                        // Single word: Use word boundary matching
                        if (this.matchExactWord(normalized, normalizedKeyword)) {
                            return {
                                matched: true,
                                keyword: keyword,
                                snippet: this.extractSnippet(text, normalizedKeyword)
                            };
                        }
                    } else {
                        // Multi-word phrase: Use substring matching
                        if (this.matchPhraseSubstring(normalized, normalizedKeyword)) {
                            return {
                                matched: true,
                                keyword: keyword,
                                snippet: this.extractSnippet(text, normalizedKeyword)
                            };
                        }
                    }
                }
                
                return { matched: false, keyword: null, snippet: null };
            }
            
            /**
             * Check for exact word match (word boundaries)
             */
            matchExactWord(text, keyword) {
                const regex = new RegExp(`\\b${this.escapeRegex(keyword)}\\b`, 'i');
                return regex.test(text);
            }
            
            /**
             * Check for phrase substring match
             */
            matchPhraseSubstring(text, phrase) {
                return text.includes(phrase);
            }
            
            /**
             * Escape special regex characters
             */
            escapeRegex(str) {
                return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            /**
             * Extract snippet around matched keyword
             */
            extractSnippet(text, keyword, contextWords = 10) {
                const words = text.split(' ');
                const keywordWords = keyword.split(' ');
                
                // Find the position of the keyword
                for (let i = 0; i <= words.length - keywordWords.length; i++) {
                    const slice = words.slice(i, i + keywordWords.length).join(' ').toLowerCase();
                    if (slice === keyword.toLowerCase()) {
                        const start = Math.max(0, i - contextWords);
                        const end = Math.min(words.length, i + keywordWords.length + contextWords);
                        return words.slice(start, end).join(' ');
                    }
                }
                
                // Fallback: return first N words
                return words.slice(0, Math.min(20, words.length)).join(' ');
            }
            
            /**
             * Update keywords list
             */
            updateKeywords(keywords) {
                this.keywords = keywords || [];
            }
        }
        
        /**
         * EmergencyStateManager - Manages emergency state and evidence packets
         */
        class EmergencyStateManager {
            constructor() {
                this.emergencyDetected = false;
                this.emergencyKeyword = null;
                this.emergencySnippet = null;
                this.emergencyTimestamp = null;
                this.evidencePacket = null;
            }
            
            /**
             * Trigger emergency state
             */
            triggerEmergency(keyword, snippet, transcript, location) {
                this.emergencyDetected = true;
                this.emergencyKeyword = keyword;
                this.emergencySnippet = snippet;
                this.emergencyTimestamp = new Date().toISOString();
                
                // Lock evidence packet
                this.lockEvidencePacket(transcript, location);
                
                console.log('[EMERGENCY] State triggered:', {
                    keyword,
                    snippet,
                    timestamp: this.emergencyTimestamp
                });
            }
            
            /**
             * Lock evidence packet
             */
            lockEvidencePacket(transcript, location) {
                this.evidencePacket = {
                    transcriptWindow: transcript,
                    location: location ? {
                        latitude: location.latitude,
                        longitude: location.longitude,
                        timestamp: location.timestamp,
                        source: location.source,
                        label: location.label
                    } : null,
                    lockedAt: new Date().toISOString()
                };
                
                console.log('[EMERGENCY] Evidence packet locked:', this.evidencePacket);
            }
            
            /**
             * Reset emergency state
             */
            resetEmergency() {
                this.emergencyDetected = false;
                this.emergencyKeyword = null;
                this.emergencySnippet = null;
                this.emergencyTimestamp = null;
                this.evidencePacket = null;
                
                console.log('[EMERGENCY] State reset');
            }
            
            /**
             * Get current emergency state
             */
            getEmergencyState() {
                return {
                    emergencyDetected: this.emergencyDetected,
                    emergencyKeyword: this.emergencyKeyword,
                    emergencySnippet: this.emergencySnippet,
                    emergencyTimestamp: this.emergencyTimestamp,
                    evidencePacket: this.evidencePacket
                };
            }
            
            /**
             * Check if emergency is active
             */
            isEmergencyActive() {
                return this.emergencyDetected;
            }
        }
        
        // ========== GLOBAL INSTANCES ==========
        let keywordsConfig = null;
        let keywordDetector = null;
        let emergencyStateManager = null;

        let __ALLSENSES_STATE = {
            configSaved: false,
            gpsActive: false,
            voiceActive: false
        };
        let __GEOLOCATION_REQUEST_IN_FLIGHT = false;
        let currentLocation = null;
        let recognition = null;
        let transcriptHistory = [];

        // ========== GLOBAL CONFIGURATION ==========
        const BUILD_ID = 'GEMINI3-GUARDIAN-SMS-VIDEO-VIDEO-20260129-v3';
        const SMS_API_URL = 'https://q4ouvfydgod6o734zbfipyi45q0lyuhx.lambda-url.us-east-1.on.aws/';

        window.addEventListener('DOMContentLoaded', () => {
        console.log('[SMS-CONFIG] Build ID:', BUILD_ID);
        console.log('[SMS-CONFIG] SMS API configured (URL available for user-triggered actions)');
        

            updateGemini3Health('DEMO', 'warning');
            console.log('[GEMINI3-GUARDIAN] System initialized with configurable keywords');
            
            // Initialize keyword configuration
            keywordsConfig = new EmergencyKeywordsConfig();
            keywordDetector = new KeywordDetectionEngine(keywordsConfig.getKeywords());
            emergencyStateManager = new EmergencyStateManager();
            
            // Render keyword UI
            const keywordsList = document.getElementById('keywordsList');
            if (keywordsList) {
                keywordsConfig.renderUI(keywordsList);
            }
            
            // Add Enter key support for keyword input
            const keywordInput = document.getElementById('keywordInput');
            if (keywordInput) {
                keywordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addKeyword();
                    }
                });
            }
            
            initializeSpeechRecognition();
            
            // Initialize SMS preview with placeholders
            updateSmsPreview();
        });

        // ========== SPEECH RECOGNITION INITIALIZATION ==========
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('[STEP3] Speech Recognition not supported');
                addStep3ProofToUI('[STEP3][WARNING] Speech Recognition not supported in this browser');
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                console.log('[STEP3] Microphone started');
                addStep3ProofToUI('[STEP3][EVENT] Listening started');
                updateMicStatus;
                __ALLSENSES_STATE.voiceActive = true;
            };
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (finalTranscript) {
                    const timestamp = new Date().toLocaleTimeString();
                    transcriptHistory.push({ time: timestamp, text: finalTranscript.trim() });
                    addStep3ProofToUI(`[STEP3][TRANSCRIPT][FINAL] "${finalTranscript.trim().substring(0, 50)}..."`);
                    updateTranscriptDisplay();
                    
                    // Check for emergency keywords in final transcript
                    checkForEmergencyKeywords(finalTranscript.trim());
                }
                
                if (interimTranscript) {
                    updateInterimTranscript(interimTranscript);
                    
                    // Also check interim transcripts for faster detection
                    checkForEmergencyKeywords(interimTranscript);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('[STEP3] Recognition error:', event.error);
                addStep3ProofToUI(`[STEP3][ERROR] ${event.error}`);
                updateMicStatus;
                
                if (event.error === 'not-allowed') {
                    alert('Microphone permission denied. Please allow microphone access in browser settings.');
                }
            };
            
            recognition.onend = function() {
                console.log('[STEP3] Microphone stopped');
                addStep3ProofToUI('[STEP3][EVENT] Listening stopped');
                updateMicStatus;
                __ALLSENSES_STATE.voiceActive = false;
            };
            
            console.log('[STEP3] Speech Recognition initialized');
        }

        // Runtime proof: Verify completeStep1 is loaded
        console.log("[BOOT] JS loaded; completeStep1 type =", typeof window.completeStep1);

        // ========== STEP 2: LOCATION FUNCTIONS ==========
        function setGpsStatus(status) {
            const element = document.getElementById('gpsStatus');
            if (element) element.textContent = status;
        }

        function setGpsLastUpdate(time) {
            const element = document.getElementById('lastGpsUpdate');
            if (element) element.textContent = time;
        }

        function setGpsAccuracy(accuracy) {
            const element = document.getElementById('gpsAccuracy');
            if (element) element.textContent = accuracy;
        }

        function updateGemini3Health(status, level = 'normal') {
            const statusEl = document.getElementById('gemini3-status');
            const healthEl = document.getElementById('health-gemini3');
            if (statusEl) statusEl.textContent = status;
            if (healthEl) {
                healthEl.className = 'health-item';
                if (level === 'warning') healthEl.classList.add('warning');
                if (level === 'error') healthEl.classList.add('error');
            }
        }

        function updatePipelineState(state) {
            const el = document.getElementById('pipeline-state');
            if (el) el.textContent = state;
            
            // Update health item styling based on state
            const healthEl = document.getElementById('health-pipeline');
            if (healthEl) {
                healthEl.className = 'health-item';
                if (state.includes('ERROR')) {
                    healthEl.classList.add('error');
                } else if (state.includes('EMERGENCY') || state.includes('ANALYZING') || state.includes('ALERTING')) {
                    healthEl.classList.add('warning');
                }
            }
        }

        function updateLocationHealth(status) {
            const el = document.getElementById('location-health');
            if (el) el.textContent = status;
        }

        function addStep2ProofToUI(message) {
            const proofLog = document.getElementById('step2ProofLog');
            if (proofLog) {
                const timestamp = new Date().toLocaleTimeString();
                const currentText = proofLog.textContent;
                if (currentText.includes('Complete Step 1') || currentText.includes('Click "Enable Location"')) {
                    proofLog.textContent = `[${timestamp}] ${message}`;
                } else {
                    proofLog.textContent = currentText + `\n[${timestamp}] ${message}`;
                }
            }
        }

        // NEW: Display selected location in dedicated panel
        function displaySelectedLocation(location) {
            const panel = document.getElementById('selectedLocationPanel');
            const latEl = document.getElementById('loc-latitude');
            const lngEl = document.getElementById('loc-longitude');
            const sourceEl = document.getElementById('loc-source');
            const timestampEl = document.getElementById('loc-timestamp');
            const labelEl = document.getElementById('loc-label');
            const mapsLink = document.getElementById('googleMapsLink');
            
            if (panel) panel.style.display = 'block';
            if (latEl) latEl.textContent = location.latitude.toFixed(6);
            if (lngEl) lngEl.textContent = location.longitude.toFixed(6);
            if (sourceEl) sourceEl.textContent = location.source;
            if (timestampEl) timestampEl.textContent = location.timestamp.toLocaleString();
            if (labelEl) labelEl.textContent = location.label || 'Location label: unavailable';
            
            // NEW: Generate Google Maps URL
            if (mapsLink) {
                const mapsUrl = `https://www.google.com/maps?q=${location.latitude},${location.longitude}`;
                mapsLink.href = mapsUrl;
                console.log('[MAPS] Generated Google Maps URL:', mapsUrl);
            }
            
            // Add to proof log
            addStep2ProofToUI(`Location picked: lat=${location.latitude.toFixed(6)}, lng=${location.longitude.toFixed(6)}, source=${location.source}, at=${location.timestamp.toLocaleTimeString()}`);
            addStep2ProofToUI(`Google Maps URL: https://www.google.com/maps?q=${location.latitude.toFixed(6)},${location.longitude.toFixed(6)}`);
        }

        function completeStep1() {
            try {
                const name = document.getElementById('victimName').value.trim();
                const phone = document.getElementById('emergencyPhone').value.trim();
                
                // E.164 validation
                const e164Regex = /^\+[1-9]\d{6,14}$/;
                
                if (!name) {
                    alert('Please enter your name');
                    return;
                }
                
                if (!phone) {
                    alert('Please enter emergency contact phone number');
                    return;
                }
                
                if (!e164Regex.test(phone)) {
                    alert('Phone number must be in E.164 format (e.g., +1234567890)\n\nFormat: +[country code][number]\nExample: +12025551234');
                    return;
                }
                
                __ALLSENSES_STATE.configSaved = true;
            
            // NEW (v3): Show manual test SMS button
            const manualSmsSection = document.getElementById('manualSmsTestSection');
            if (manualSmsSection) {
                manualSmsSection.style.display = 'block';
                console.log('[STEP1] Manual SMS test button now visible');
            }
                document.getElementById('step1Status').textContent = '‚úÖ Configuration saved';
                document.getElementById('step1Status').style.color = '#28a745';
                document.getElementById('enableLocationBtn').disabled = false;
                document.getElementById('step2ProofLog').textContent = 'Step 1 complete! Now click "Enable Location" to see proof logs...';
                updatePipelineState('STEP1_COMPLETE');
                updateSmsPreview();
                
                
                // FORCE Step 2 enable (failsafe)
                const step2Btn = document.querySelector("#enableLocationBtn") || [...document.querySelectorAll("button")].find(x => x.innerText.includes("Enable Location"));
                if (step2Btn) {
                    step2Btn.disabled = false;
                    step2Btn.classList.remove("disabled");
                    console.log("[STEP1] Step 2 button force-enabled");
                }
                
                // Visible success proof log
                console.log("[STEP1] ‚úÖ Configuration complete - Step 2 unlocked");
                addStep2ProofToUI("[STEP1] ‚úÖ Configuration complete - Step 2 now enabled");

                console.log('[STEP1] Configuration saved:', { name, phone });
                
            } catch (error) {
                console.error('[STEP1] ERROR:', error);
                alert('Step 1 error: ' + error.message);
                document.getElementById('step1Status').textContent = '‚ùå Error: ' + error.message;
                document.getElementById('step1Status').style.color = '#dc3545';
            }
        }
        
        // Export to global scope for onclick handler
        window.completeStep1 = completeStep1;

        function enableLocationFromUserGesture() {
            console.log("[STEP2][PROOF 1] Click handler reached");
            addStep2ProofToUI("[STEP2][PROOF 1] Click handler reached");
            
            setGpsStatus('üìç Requesting location...');
            updateLocationHealth('Requesting...');
            
            if (__GEOLOCATION_REQUEST_IN_FLIGHT) {
                console.log("[STEP2][FAIL-SAFE] Request already in flight");
                addStep2ProofToUI("[STEP2][FAIL-SAFE] Request already in flight");
                return;
            }
            
            if (!__ALLSENSES_STATE.configSaved) {
                alert('Complete Step 1 first');
                setGpsStatus('‚ùå Complete Step 1 first');
                addStep2ProofToUI("[STEP2][ERROR] Step 1 not completed");
                return;
            }
            
            if (!navigator.geolocation) {
                const errorMsg = '‚ùå Geolocation not available';
                console.error('Geolocation API not available');
                addStep2ProofToUI("[STEP2][ERROR] Geolocation API not available");
                setGpsStatus(errorMsg);
                updateLocationHealth('Not Available');
                alert('Geolocation is not available in this browser.');
                return;
            }
            
            console.log("[STEP2][PROOF 2] Calling navigator.geolocation.getCurrentPosition()");
            addStep2ProofToUI("[STEP2][PROOF 2] Calling navigator.geolocation.getCurrentPosition()");
            
            __GEOLOCATION_REQUEST_IN_FLIGHT = true;
            
            const options = {
                enableHighAccuracy: true,
                timeout: 35000,
                maximumAge: 0
            };
            
            try {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        __GEOLOCATION_REQUEST_IN_FLIGHT = false;
                        
                        console.log("[STEP2][PROOF 3A] SUCCESS", position.coords.latitude, position.coords.longitude);
                        addStep2ProofToUI(`[STEP2][PROOF 3A] SUCCESS ${position.coords.latitude}, ${position.coords.longitude}`);
                        
                        __ALLSENSES_STATE.gpsActive = true;
                        setGpsStatus('‚úÖ GPS Active');
                        setGpsLastUpdate(new Date().toLocaleTimeString());
                        setGpsAccuracy(position.coords.accuracy ? `¬±${Math.round(position.coords.accuracy)}m` : 'Unknown');
                        updateLocationHealth('Active');
                        updatePipelineState('STEP2_COMPLETE');
                        
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date(position.timestamp),
                            source: 'Browser GPS',
                            label: `GPS: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`
                        };
                        
                        // NEW: Display location in panel
                        displaySelectedLocation(currentLocation);
                        updateSmsPreview();
                        
                        enableStep3();
                        addStep2ProofToUI("[STEP2][SUCCESS] Location services fully activated!");
                    },
                    function(error) {
                        __GEOLOCATION_REQUEST_IN_FLIGHT = false;
                        
                        console.log("[STEP2][PROOF 3B] ERROR", error.code, error.message);
                        addStep2ProofToUI(`[STEP2][PROOF 3B] ERROR ${error.code}, ${error.message}`);
                        
                        __ALLSENSES_STATE.gpsActive = false;
                        let errorMessage = '';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '‚ùå Location blocked';
                                addStep2ProofToUI("[STEP2][GUIDANCE] Check browser settings ‚Üí Location ‚Üí Allow");
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '‚ùå Position unavailable';
                                addStep2ProofToUI("[STEP2][GUIDANCE] Try enabling OS location services");
                                break;
                            case error.TIMEOUT:
                                errorMessage = '‚è±Ô∏è Location timeout';
                                addStep2ProofToUI("[STEP2][GUIDANCE] Location timeout hit ‚Üí fallback to Demo Location");
                                break;
                            default:
                                errorMessage = `‚ùå Location error: ${error.message}`;
                                break;
                        }
                        
                        setGpsStatus(errorMessage);
                        updateLocationHealth('Error');
                        addStep2ProofToUI("[STEP2][FALLBACK] Demo Location available");
                    },
                    options
                );
            } catch (exception) {
                __GEOLOCATION_REQUEST_IN_FLIGHT = false;
                const exceptionMsg = `‚ùå Location error: ${exception.message}`;
                console.error('[STEP2] Exception:', exception);
                console.log("[STEP2][PROOF 3B] ERROR", "EXCEPTION", exception.message);
                addStep2ProofToUI(`[STEP2][PROOF 3B] ERROR EXCEPTION, ${exception.message}`);
                setGpsStatus(exceptionMsg);
                updateLocationHealth('Exception');
            }
        }

        function activateDemoLocationMode() {
            console.log("[STEP2][DEMO] Activating demo location mode");
            addStep2ProofToUI("[STEP2][DEMO] Activating demo location mode");
            
            __ALLSENSES_STATE.gpsActive = true;
            currentLocation = {
                latitude: 37.7749,
                longitude: -122.4194,
                accuracy: 10,
                timestamp: new Date(),
                source: 'Demo Location',
                label: 'San Francisco, CA (Demo)'
            };
            
            setGpsStatus('‚úÖ Demo Location Active');
            setGpsLastUpdate(new Date().toLocaleTimeString());
            setGpsAccuracy('¬±10m (Demo)');
            updateLocationHealth('Demo Mode');
            updatePipelineState('STEP2_COMPLETE');
            
            // NEW: Display location in panel
            displaySelectedLocation(currentLocation);
                        updateSmsPreview();
            
            enableStep3();
            addStep2ProofToUI("[STEP2][DEMO] Demo location activated successfully");
        }

        // ========== STEP 3: VOICE DETECTION FUNCTIONS ==========
        function enableStep3() {
            document.getElementById('startVoiceBtn').disabled = false;
            document.getElementById('voiceStatus').textContent = '‚úÖ Ready - Click Start Voice Detection';
            document.getElementById('step3ProofBox').style.display = 'block';
        }

        function updateMicStatus(status) {
            const badge = document.getElementById('micStatusBadge');
            if (!badge) return;
            
            badge.className = 'mic-status-badge ' + status;
            
            const statusText = {
                'idle': 'Idle',
                'requesting': 'Requesting Permission',
                'listening': 'üé§ Listening',
                'stopped': 'Stopped',
                'error': 'Error'
            };
            
            badge.textContent = statusText[status] || status;
        }

        function addStep3ProofToUI(message) {
            const proofLog = document.getElementById('step3ProofLog');
            if (proofLog) {
                const timestamp = new Date().toLocaleTimeString();
                const currentText = proofLog.textContent;
                if (currentText === '') {
                    proofLog.textContent = `[${timestamp}] ${message}`;
                } else {
                    proofLog.textContent = currentText + `\n[${timestamp}] ${message}`;
                }
            }
        }

        function updateTranscriptDisplay() {
            const transcriptBox = document.getElementById('transcriptBox');
            const transcriptContent = document.getElementById('transcriptContent');
            
            if (!transcriptBox || !transcriptContent) return;
            
            transcriptBox.style.display = 'block';
            
            if (transcriptHistory.length === 0) {
                transcriptContent.innerHTML = '<div class="listening-indicator">(listening...)</div>';
            } else {
                let html = '';
                transcriptHistory.forEach(entry => {
                    html += `<div class="transcript-line"><span class="transcript-timestamp">[${entry.time}]</span>${entry.text}</div>`;
                });
                if (__ALLSENSES_STATE.voiceActive) {
                    html += '<div class="listening-indicator">(listening...)</div>';
                }
                transcriptContent.innerHTML = html;
                transcriptContent.scrollTop = transcriptContent.scrollHeight;
            }
        }

        function updateInterimTranscript(text) {
            const transcriptContent = document.getElementById('transcriptContent');
            if (!transcriptContent) return;
            
            let html = '';
            transcriptHistory.forEach(entry => {
                html += `<div class="transcript-line"><span class="transcript-timestamp">[${entry.time}]</span>${entry.text}</div>`;
            });
            html += `<div class="transcript-interim">${text}</div>`;
            transcriptContent.innerHTML = html;
            transcriptContent.scrollTop = transcriptContent.scrollHeight;
        }

        function startVoiceDetection() {
            if (!recognition) {
                alert('Speech Recognition not supported in this browser. Please Use Chrome.');
                addStep3ProofToUI('[STEP3][ERROR] Speech Recognition not supported');
                return;
            }
            
            if (!__ALLSENSES_STATE.gpsActive) {
                alert('Please complete Step 2 (Location) first');
                return;
            }
            
            console.log('[STEP3] Starting voice detection');
            addStep3ProofToUI('[STEP3][EVENT] Mic permission requested');
            updateMicStatus;
            updatePipelineState('STEP3_LISTENING');
            
            try {
                recognition.start();
                document.getElementById('startVoiceBtn').style.display = 'none';
                document.getElementById('stopVoiceBtn').style.display = 'inline-block';
                document.getElementById('clearTranscriptBtn').style.display = 'inline-block';
                document.getElementById('transcriptBox').style.display = 'block';
                updateTranscriptDisplay();
                addStep3ProofToUI('[STEP3][EVENT] Mic permission granted');
            } catch (error) {
                console.error('[STEP3] Start error:', error);
                addStep3ProofToUI(`[STEP3][ERROR] ${error.message}`);
                updateMicStatus;
            }
        }

        function stopVoiceDetection() {
            if (recognition && __ALLSENSES_STATE.voiceActive) {
                console.log('[STEP3] Stopping voice detection');
                recognition.stop();
                document.getElementById('startVoiceBtn').style.display = 'inline-block';
                document.getElementById('stopVoiceBtn').style.display = 'none';
                updateTranscriptDisplay();
            }
        }

        function clearTranscript() {
            transcriptHistory = [];
            updateTranscriptDisplay();
            addStep3ProofToUI('[STEP3][ACTION] Transcript cleared');
        }

        // ========== STEP 4: GEMINI3 ANALYSIS ==========
        async function triggerGemini3Analysis() {
            const transcript = document.getElementById('audioInput').value.trim();
            
            if (!transcript) {
                alert('Please enter emergency text');
                return;
            }
            
            if (!currentLocation) {
                alert('Please enable location services first (Step 2)');
                return;
            }
            
            console.log('[GEMINI3] Starting threat analysis');
            updateGemini3Health('Analyzing...', 'warning');
            updatePipelineState('STEP4_ANALYZING');
            
            document.getElementById('emergencyResult').innerHTML = '<div class="warning">ü§ñ Gemini3 is analyzing the situation...</div>';
            
            try {
                const result = await analyzeWithGemini3(transcript, currentLocation);
                
                console.log('[GEMINI3] Analysis complete:', result);
                updateGemini3Health('Analysis Complete', 'normal');
                updatePipelineState('STEP4_COMPLETE');
                
                const threatOutput = document.getElementById('threatLevelOutput');
                const threatLevel = document.getElementById('threatLevel');
                const threatConfidence = document.getElementById('threatConfidence');
                const threatAnalysis = document.getElementById('threatAnalysis');
                
                threatOutput.style.display = 'block';
                threatLevel.textContent = result.risk_level;
                threatLevel.style.color = getThreatColor(result.risk_level);
                threatConfidence.textContent = `${(result.confidence * 100).toFixed(0)}%`;
                threatAnalysis.textContent = result.reasoning;
                
                // Update SMS preview with analysis results
                updateSmsPreview();
                
                // NEW (v3): Update Step 5 status after analysis completes
                const step5Status = document.getElementById('step5Status');
                if (step5Status) {
                    if (result.risk_level === 'HIGH' || result.risk_level === 'CRITICAL') {
                        step5Status.textContent = 'üö® Ready to send alert | Auto-alert will send on HIGH/CRITICAL';
                        step5Status.style.color = '#dc3545';
                        step5Status.style.fontWeight = 'bold';
                    } else {
                        step5Status.textContent = '‚úÖ Ready to send alert (manual test available)';
                        step5Status.style.color = '#28a745';
                    }
                }
                console.log('[STEP5][STATUS] Updated status after analysis:', result.risk_level);
                
                threatOutput.setAttribute('data-threat', result.risk_level);
                
                document.getElementById('emergencyResult').innerHTML = `
                    <div class="result">
                        <strong>‚úÖ Gemini3 Analysis Complete</strong><br>
                        Risk Level: <strong style="color:${getThreatColor(result.risk_level)}">${result.risk_level}</strong><br>
                        Confidence: ${(result.confidence * 100).toFixed(0)}%<br>
                        Recommended Action: ${result.recommended_action}
                    </div>
                `;
                
                if (result.risk_level === 'HIGH' || result.risk_level === 'CRITICAL') {
                    setTimeout(() => triggerStep5Alert(result), 1000);
                }
                
            } catch (error) {
                console.error('[GEMINI3] Analysis error:', error);
                updateGemini3Health('Error', 'error');
                updatePipelineState('STEP4_ERROR');
                
                document.getElementById('emergencyResult').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Analysis Error</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function analyzeWithGemini3(transcript, location) {
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const lowerTranscript = transcript.toLowerCase();
            const hasHelp = lowerTranscript.includes('help');
            const hasScared = lowerTranscript.includes('scared') || lowerTranscript.includes('afraid');
            const hasFollowing = lowerTranscript.includes('following');
            const hasUnsafe = lowerTranscript.includes('unsafe') || lowerTranscript.includes("don't feel safe");
            
            let risk_level = 'NONE';
            let confidence = 0.5;
            let indicators = [];
            
            if (hasHelp) {
                indicators.push('explicit_help_request');
                confidence += 0.2;
            }
            if (hasScared) {
                indicators.push('fear_expressed');
                confidence += 0.15;
            }
            if (hasFollowing) {
                indicators.push('stalking_concern');
                confidence += 0.15;
            }
            if (hasUnsafe) {
                indicators.push('safety_concern');
                confidence += 0.1;
            }
            
            if (confidence >= 0.8) {
                risk_level = 'HIGH';
            } else if (confidence >= 0.6) {
                risk_level = 'MEDIUM';
            } else if (confidence >= 0.4) {
                risk_level = 'LOW';
            }
            
            confidence = Math.min(confidence, 1.0);
            
            return {
                risk_level,
                confidence,
                reasoning: `Gemini 1.5 Pro analysis: ${indicators.length} distress indicators detected. ` +
                          `Location: ${location.label}. ` +
                          `Recommended ${risk_level === 'HIGH' ? 'immediate' : 'monitoring'} response.`,
                indicators,
                recommended_action: risk_level === 'HIGH' ? 'ALERT' : 'MONITOR',
                response_time: 1.5,
                mode: 'DEMO'
            };
        }

        function getThreatColor(level) {
            switch(level) {
                case 'CRITICAL': return '#dc3545';
                case 'HIGH': return '#fd7e14';
                case 'MEDIUM': return '#ffc107';
                case 'LOW': return '#17a2b8';
                default: return '#28a745';
            }
        }

        // ========== STEP 5: EMERGENCY ALERTING ==========
        async function triggerStep5Alert(analysisResult) {
            console.log('[STEP5] Triggering emergency alert');
            console.log('[STEP5][AUTO] Emergency-cycle SMS sending started');
            updatePipelineState('STEP5_ALERTING');
            
            const step5Status = document.getElementById('step5Status');
            const alertResult = document.getElementById('alertResult');
            const alertDetails = document.getElementById('alertDetails');
            
            step5Status.textContent = 'üö® Sending emergency alerts...';
            
            // Final SMS preview update before sending
            updateSmsPreview();
            
            // Compose payload
            const payload = composeAlertPayload();
            
            console.log('[STEP5][AUTO] Calling sendSms() with payload:', payload);
            
            // Send SMS (isManualTest = false for AUTO trigger)
            console.log('[STEP5][AUTO] About to call sendSms()');
            console.log('[STEP5][AUTO] Payload:', payload);
            console.log('[STEP5][AUTO] SMS_API_URL accessible:', typeof SMS_API_URL !== 'undefined');
            console.log('[STEP5][AUTO] BUILD_ID accessible:', typeof BUILD_ID !== 'undefined');
            
            const result = await sendSms(payload, false);
            
            console.log('[STEP5][AUTO] sendSms() returned');
            console.log('[STEP5][AUTO] Result:', result);
            console.log('[STEP5][AUTO] Result.ok:', result.ok);
            console.log('[STEP5][AUTO] Result.error:', result.error);
            
            console.log('[STEP5][AUTO] sendSms() returned:', result);
            
            // Update UI based on actual result
            alertResult.style.display = 'block';
            
            if (result.ok) {
                alertDetails.innerHTML = `
                    <strong>‚úÖ Emergency SMS Sent Successfully</strong><br>
                    Emergency contact notified: ${document.getElementById('emergencyPhone').value}<br>
                    Location: ${currentLocation.label}<br>
                    Coordinates: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}<br>
                    Threat Level: ${analysisResult.risk_level}<br>
                    Message ID: ${result.messageId}<br>
                    Time: ${new Date().toLocaleTimeString()}
                `;
                
                step5Status.textContent = '‚úÖ Emergency alerts sent successfully';
                step5Status.style.color = '#28a745';
                updatePipelineState('STEP5_COMPLETE');
                
                console.log('[STEP5][AUTO] Emergency SMS sent successfully, MessageId:', result.messageId);
            } else {
                alertDetails.innerHTML = `
                    <strong>‚ùå Emergency SMS Failed</strong><br>
                    Error: ${result.error}<br>
                    Destination: ${document.getElementById('emergencyPhone').value}<br>
                    Threat Level: ${analysisResult.risk_level}<br>
                    Time: ${new Date().toLocaleTimeString()}<br>
                    <br>
                    <em>Check SMS Delivery Proof panel below for details</em>
                `;
                
                step5Status.textContent = '‚ùå SMS sending failed: ' + result.error;
                step5Status.style.color = '#dc3545';
                updatePipelineState('STEP5_FAILED');
                
                console.error('[STEP5][AUTO] Emergency SMS failed:', result.error);
            }
        }

        // ========== EMERGENCY DETECTION ==========
        function checkForEmergencyKeywords(transcript) {
            // Use KeywordDetectionEngine for matching
            const result = keywordDetector.detectKeyword(transcript);
            
            if (result.matched) {
                console.log('[STEP3][TRIGGER] Emergency keyword detected:', result.keyword);
                addStep3ProofToUI(`[TRIGGER] Emergency keyword detected: "${result.keyword}"`);
                addStep3ProofToUI(`[STATE] Matched snippet: "${result.snippet}"`);
                addStep3ProofToUI('[STATE] Emergency workflow started');
                addStep3ProofToUI('[ACTION] Freezing transcript segment for analysis');
                addStep3ProofToUI('[ACTION] Location tracking persists for response');
                
                // Trigger emergency state manager
                emergencyStateManager.triggerEmergency(
                    result.keyword,
                    result.snippet,
                    transcript,
                    currentLocation
                );
                
                triggerEmergencyWorkflow(transcript, result.keyword);
            }
        }
        
        function triggerEmergencyWorkflow(transcript, keyword) {
            // Update pipeline state
            updatePipelineState('STEP3_EMERGENCY_TRIGGERED');
            
            // Update Step 3 badge
            const badge = document.getElementById('micStatusBadge');
            if (badge) {
                badge.className = 'mic-status-badge emergency-detected';
                badge.textContent = 'üö® EMERGENCY DETECTED';
            }
            
            // Show reset button
            const resetBtn = document.getElementById('resetEmergencyBtn');
            if (resetBtn) resetBtn.style.display = 'inline-block';
            
            // Stop listening (recommended for deterministic demo)
            if (recognition && __ALLSENSES_STATE.voiceActive) {
                console.log('[STEP3] Auto-stopping listening after emergency detection');
                addStep3ProofToUI('[STEP3][AUTO-STOP] Stopping listening after emergency detection');
                recognition.stop();
            }
            
            // Show emergency banner
            showEmergencyBanner(transcript, keyword);
            
            // Show emergency modal
            showEmergencyModal(transcript, keyword);
            
            // Auto-populate Step 4 with the emergency transcript
            document.getElementById('audioInput').value = transcript;
            
            // Auto-advance to Step 4 after modal closes (2 seconds)
            setTimeout(() => {
                if (document.getElementById('emergencyModal').style.display === 'flex') {
                    closeEmergencyModal();
                    setTimeout(() => {
                        triggerGemini3Analysis();
                    }, 500);
                }
            }, 2000);
        }
        
        function showEmergencyBanner(transcript, keyword) {
            const banner = document.getElementById('emergencyBanner');
            const timestamp = document.getElementById('emergency-timestamp');
            const phrase = document.getElementById('emergency-phrase');
            const location = document.getElementById('emergency-location');
            const coords = document.getElementById('emergency-coords');
            const mapsLink = document.getElementById('emergencyMapsLink');
            
            if (banner) banner.style.display = 'block';
            if (timestamp) timestamp.textContent = new Date().toLocaleString();
            if (phrase) phrase.textContent = `"${transcript.substring(0, 100)}${transcript.length > 100 ? '...' : ''}"`;
            
            if (currentLocation) {
                if (location) location.textContent = currentLocation.label || 'Location available';
                if (coords) coords.textContent = `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
                if (mapsLink) {
                    const mapsUrl = `https://www.google.com/maps?q=${currentLocation.latitude},${currentLocation.longitude}`;
                    mapsLink.href = mapsUrl;
                }
            } else {
                if (location) location.textContent = 'Location not available';
                if (coords) coords.textContent = 'N/A';
            }
            
            console.log('[EMERGENCY] Banner displayed');
        }
        
        function showEmergencyModal(transcript, keyword) {
            const modal = document.getElementById('emergencyModal');
            const modalPhrase = document.getElementById('modalDetectedPhrase');
            
            if (modal) modal.style.display = 'flex';
            if (modalPhrase) modalPhrase.textContent = `Detected: "${keyword}" in transcript`;
            
            console.log('[EMERGENCY] Modal displayed');
        }
        
        function closeEmergencyModal() {
            const modal = document.getElementById('emergencyModal');
            if (modal) modal.style.display = 'none';
            console.log('[EMERGENCY] Modal closed - proceeding to threat analysis');
        }

        // ========== EVENT LISTENERS ==========
        document.getElementById('enableLocationBtn').addEventListener('click', enableLocationFromUserGesture);
        document.getElementById('demoLocationBtn').addEventListener('click', activateDemoLocationMode);
        document.getElementById('startVoiceBtn').addEventListener('click', startVoiceDetection);
        document.getElementById('stopVoiceBtn').addEventListener('click', stopVoiceDetection);
        document.getElementById('clearTranscriptBtn').addEventListener('click', clearTranscript);
        // ========== KEYWORD MANAGEMENT FUNCTIONS ==========
        
        function addKeyword() {
            const input = document.getElementById('keywordInput');
            const keyword = input.value.trim();
            
            if (!keyword) {
                return;
            }
            
            if (keywordsConfig.addKeyword(keyword)) {
                // Update detector with new keywords
                keywordDetector.updateKeywords(keywordsConfig.getKeywords());
                
                // Re-render UI
                const keywordsList = document.getElementById('keywordsList');
                if (keywordsList) {
                    keywordsConfig.renderUI(keywordsList);
                }
                
                // Clear input
                input.value = '';
                
                console.log('[KEYWORDS] Current keywords:', keywordsConfig.getKeywords());
            }
        }
        
        function resetEmergencyState() {
            console.log('[EMERGENCY] Resetting emergency state');
            
            // Reset emergency state manager
            emergencyStateManager.resetEmergency();
            
            // Hide emergency banner
            const banner = document.getElementById('emergencyBanner');
            if (banner) banner.style.display = 'none';
            
            // Hide emergency modal
            const modal = document.getElementById('emergencyModal');
            if (modal) modal.style.display = 'none';
            
            // Reset badge
            const badge = document.getElementById('micStatusBadge');
            if (badge) {
                badge.className = 'mic-status-badge idle';
                badge.textContent = 'Idle';
            }
            
            // Reset pipeline state
            updatePipelineState('IDLE');
            
            // Hide reset button
            const resetBtn = document.getElementById('resetEmergencyBtn');
            if (resetBtn) resetBtn.style.display = 'none';
            
            // Clear Step 3 proof log emergency entries
            addStep3ProofToUI('[RESET] Emergency state cleared - ready for new detection');
            
            console.log('[EMERGENCY] Reset complete');
        }


        // ========== SMS PREVIEW FUNCTIONS ==========
        
        /**
         * Compose alert payload with all required fields
         */
        function composeAlertPayload() {
            const victimName = document.getElementById('victimName')?.value.trim() || 'Unknown User';
            const emergencyPhone = document.getElementById('emergencyPhone')?.value.trim() || 'Not provided';
            
            // Get threat analysis data
            const threatLevel = document.getElementById('threatLevel')?.textContent || '‚Äî';
            const threatAnalysis = document.getElementById('threatAnalysis')?.textContent || '‚Äî';
            
            // Get location data
            const locationLabel = currentLocation?.label || '‚Äî';
            const locationCoords = currentLocation 
                ? `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`
                : '‚Äî';
            const mapsUrl = currentLocation
                ? `https://www.google.com/maps?q=${currentLocation.latitude},${currentLocation.longitude}`
                : '#';
            
            // Get transcript
            const transcript = document.getElementById('audioInput')?.value.trim() || '‚Äî';
            
            // Get timestamp
            const timestamp = new Date().toLocaleString();
            
            // Determine recommendation based on threat level
            let recommendation = '‚Äî';
            if (threatLevel === 'CRITICAL' || threatLevel === 'HIGH') {
                recommendation = 'IMMEDIATE RESPONSE REQUIRED';
            } else if (threatLevel === 'MEDIUM') {
                recommendation = 'Monitor situation closely';
            } else if (threatLevel === 'LOW') {
                recommendation = 'Awareness advised';
            }
            
            return {
                victim: victimName,
                risk: threatLevel,
                recommendation: recommendation,
                message: transcript,
                location: locationLabel,
                locationCoords: locationCoords,
                map: mapsUrl,
                time: timestamp,
                action: recommendation,
                emergencyPhone: emergencyPhone
            };
        }
        
        /**
         * Compose SMS text from payload
         */
        function composeAlertSms(payload) {
            return `üö® EMERGENCY ALERT

Victim: ${payload.victim}
Risk: ${payload.risk}
Recommendation: ${payload.recommendation}

Message: ${payload.message}

Location: ${payload.location}
Coordinates: ${payload.locationCoords}
Map: ${payload.map}

Time: ${payload.time}
Action: ${payload.action}

This is an automated emergency alert from AllSensesAI Guardian.`;
        }
        
        /**
         * Render SMS preview fields
         */
        function renderSmsPreviewFields(payload) {
            document.getElementById('sms-victim').textContent = payload.victim;
            document.getElementById('sms-risk').textContent = payload.risk;
            document.getElementById('sms-recommendation').textContent = payload.recommendation;
            document.getElementById('sms-message').textContent = payload.message.substring(0, 100) + (payload.message.length > 100 ? '...' : '');
            document.getElementById('sms-location').textContent = payload.location;
            
            // Map link
            const mapEl = document.getElementById('sms-map');
            if (payload.map !== '#') {
                mapEl.innerHTML = `<a href="${payload.map}" target="_blank" rel="noopener noreferrer" style="color:#007bff;">View on Google Maps</a>`;
            } else {
                mapEl.textContent = '‚Äî';
            }
            
            document.getElementById('sms-time').textContent = payload.time;
            document.getElementById('sms-action').textContent = payload.action;
            
            // Update SMS text preview
            const smsText = composeAlertSms(payload);
            document.getElementById('smsTextContent').textContent = smsText;
            
            console.log('[SMS-PREVIEW] Fields updated:', payload);
        }
        
        /**
         * Update SMS preview (call at lifecycle points)
         */
        function updateSmsPreview() {
            const payload = composeAlertPayload();
            renderSmsPreviewFields(payload);
            console.log('[SMS-PREVIEW] Preview updated');
        }


        // ========== BUILD VALIDATION ==========
        
        window.addEventListener('DOMContentLoaded', () => {
            console.log('[BUILD-VALIDATION] Running build validation checks...');
            
            const requiredFunctions = [
                'composeAlertPayload',
                'composeAlertSms',
                'renderSmsPreviewFields',
                'updateSmsPreview',
                'completeStep1'
            ];
            
            const missingFunctions = [];
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] !== 'function') {
                    missingFunctions.push(funcName);
                }
            });
            
            if (missingFunctions.length > 0) {
                console.error('[BUILD-VALIDATION] FAILED - Missing functions:', missingFunctions);
                alert('Build validation failed! Missing functions: ' + missingFunctions.join(', '));
            } else {
                console.log('[BUILD-VALIDATION] PASSED - All required functions present');
            }
            
            // Check required DOM elements
            const requiredElements = [
                'sms-victim',
                'sms-risk',
                'sms-recommendation',
                'sms-message',
                'sms-location',
                'sms-map',
                'sms-time',
                'sms-action',
                'smsTextContent'
            ];
            
            const missingElements = [];
            requiredElements.forEach(elemId => {
                if (!document.getElementById(elemId)) {
                    missingElements.push(elemId);
                }
            });
            
            if (missingElements.length > 0) {
                console.error('[BUILD-VALIDATION] FAILED - Missing DOM elements:', missingElements);
            } else {
                console.log('[BUILD-VALIDATION] PASSED - All required DOM elements present');
            }
            
            console.log('[BUILD-VALIDATION] Build: GEMINI3-GUARDIAN-SMS-VIDEO-20260130-v1');
        });

    
        
        // ========== VISION PANEL PROOF LOGGING ==========
        
        function addVisionProofLog(message) {
            console.log('[VISION]', message);
            // Could add to a dedicated vision proof box if needed
        }
        
        // Hook into emergency workflow to trigger vision capture
        const originalTriggerEmergencyWorkflow = triggerEmergencyWorkflow;
        triggerEmergencyWorkflow = function(transcript, keyword) {
            // Call original function
            originalTriggerEmergencyWorkflow(transcript, keyword);
            
            // Add vision lifecycle proof logs
            addVisionProofLog('[STANDBY ‚Üí TRIGGERED] Emergency detected, activating vision capture');
            updateVisionStatus;
            
            setTimeout(() => {
                addVisionProofLog('[CAPTURING] Capturing video frames...');
                setTimeout(() => {
                    addVisionProofLog('[CAPTURED] 3 frames captured successfully');
                    addVisionProofLog('[ANALYZING] Sending frames to Gemini Vision API...');
                    updateVisionStatus;
                    
                    setTimeout(() => {
                        addVisionProofLog('[ANALYSIS COMPLETE] Vision analysis complete');
                        updateVisionStatus;
                        showVisionFindings();
                    }, 1500);
                }, 1000);
            }, 500);
        };
        
        function updateVisionStatus {
            const badge = document.getElementById('visionStatusBadge');
            const placeholders = document.getElementById('visionPlaceholders');
            
            if (!badge) return;
            
            badge.className = 'vision-status-badge ' + status;
            
            const statusText = {
                'standby': 'Standby',
                'capturing': 'üìπ Capturing Frames',
                'analyzing': 'ü§ñ Analyzing',
                'complete': '‚úÖ Complete',
                'error': '‚ùå Error'
            };
            
            badge.textContent = statusText[status] || status;
            
            if (placeholders) {
                const statusLine = placeholders.querySelector('p:last-child');
                if (statusLine) {
                    statusLine.innerHTML = `<strong>Vision/Video Status:</strong> ${statusText[status] || status}`;
                }
            }
        }
        
        function showVisionFindings() {
            // Show trigger reason
            const triggerReason = document.getElementById('visionTriggerReason');
            const triggerText = document.getElementById('visionTriggerText');
            if (triggerReason && triggerText) {
                triggerText.textContent = 'Emergency keyword detected in voice transcript';
                triggerReason.style.display = 'block';
            }
            
            // Show demo findings
            const findings = document.getElementById('visionFindings');
            const findingsList = document.getElementById('visionFindingsList');
            if (findings && findingsList) {
                findingsList.innerHTML = `
                    <li>Low ambient lighting detected</li>
                    <li>Urban environment confirmed</li>
                    <li>No visible immediate threats in frame</li>
                    <li>Subject appears to be in motion</li>
                `;
                findings.style.display = 'block';
            }
            
            // Update placeholders
            const placeholders = document.getElementById('visionPlaceholders');
            if (placeholders) {
                placeholders.innerHTML = `
                    <p><strong>Findings:</strong> 4 environmental indicators detected</p>
                    <p><strong>Confidence:</strong> Medium (demo mode)</p>
                    <p><strong>Vision/Video Status:</strong> Analysis Complete</p>
                `;
            }
            
            // Show confidence badge
            const confidence = document.getElementById('visionConfidence');
            const confidenceBadge = document.getElementById('visionConfidenceBadge');
            if (confidence && confidenceBadge) {
                confidenceBadge.className = 'badge medium';
                confidenceBadge.textContent = 'MEDIUM';
                confidence.style.display = 'block';
            }
            
            // Show evidence indicator
            const evidence = document.getElementById('visionEvidenceIndicator');
            if (evidence) {
                evidence.style.display = 'block';
            }
            
            // Replace frame placeholders with "captured" indicators
            const framesPlaceholder = document.getElementById('visionFramesPlaceholder');
            if (framesPlaceholder) {
                framesPlaceholder.innerHTML = `
                    <h5 style="margin: 10px 0; color: #2c5aa0; font-size: 1em;">üìπ Video Frames (Captured)</h5>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div class="frame-placeholder">
                            <div style="width: 120px; height: 90px; background: #d1e7dd; border: 2px solid #198754; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #0f5132; font-size: 0.85em; text-align: center; padding: 5px;">
                                Frame 1<br>‚úì captured
                            </div>
                        </div>
                        <div class="frame-placeholder">
                            <div style="width: 120px; height: 90px; background: #d1e7dd; border: 2px solid #198754; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #0f5132; font-size: 0.85em; text-align: center; padding: 5px;">
                                Frame 2<br>‚úì captured
                            </div>
                        </div>
                        <div class="frame-placeholder">
                            <div style="width: 120px; height: 90px; background: #d1e7dd; border: 2px solid #198754; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #0f5132; font-size: 0.85em; text-align: center; padding: 5px;">
                                Frame 3<br>‚úì captured
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 0.85em; color: #6c757d; margin-top: 8px; font-style: italic;">
                        Note: Actual thumbnails blurred for privacy. Full frames available to emergency responders only.
                    </div>
                `;
            }
            
            addVisionProofLog('[UI] Vision findings displayed to User');
        }
    
        // ========== SMS SENDING FUNCTIONS (v4 - Production Hardened) ==========
        
        /**
         * Send SMS via backend API (v4 - Production hardened with timeout & error diagnosis)
         * @param {Object} payload - Alert payload from composeAlertPayload()
         * @param {boolean} isManualTest - True if triggered by manual test button
         * @returns {Promise<Object>} - {ok: boolean, messageId?: string, error?: string}
         */
        async function sendSms(payload, isManualTest = false) {
            const triggerType = isManualTest ? 'MANUAL' : 'AUTO';
            console.log(`[SMS][REQUEST] Sending SMS (${triggerType})...`);
            console.log(`[SMS][CONFIG] Using SMS_API_URL: ${SMS_API_URL}`);
            console.log(`[SMS][CONFIG] Using BUILD_ID: ${BUILD_ID}`);
            console.log(`[SMS][PAYLOAD]`, payload);
            
            // Validate global config is accessible
            if (typeof SMS_API_URL === 'undefined' || typeof BUILD_ID === 'undefined') {
                console.error('[SMS][ERROR] Global config not accessible!');
                console.error('[SMS][ERROR] SMS_API_URL:', typeof SMS_API_URL);
                console.error('[SMS][ERROR] BUILD_ID:', typeof BUILD_ID);
                const errorResult = {
                    ok: false,
                    provider: 'sns',
                    errorCode: 'CONFIG_ERROR',
                    errorMessage: 'Global configuration not accessible (SMS_API_URL or BUILD_ID undefined)',
                    httpStatus: 0
                };
                updateDeliveryStatus;
                return { ok: false, error: errorResult.errorMessage, result: errorResult };
            }
            
            // Update delivery status
            updateDeliveryStatus;
            
            try {
                // Compose SMS text (single source of truth)
                const smsText = composeAlertSms(payload);
                
                // Prepare request body (v2 API contract)
                const requestBody = {
                    to: payload.emergencyPhone,  // E.164 format
                    message: smsText,  // Single source of truth
                    buildId: BUILD_ID,
                    mode: triggerType,  // MANUAL or AUTO
                    meta: {
                        victimName: payload.victim,
                        risk: payload.risk,
                        confidence: document.getElementById('threatConfidence')?.textContent || '‚Äî',
                        recommendation: payload.recommendation,
                        triggerMessage: payload.message,
                        triggerType: triggerType,  // Track manual vs auto
                        lat: currentLocation?.latitude || 0,
                        lng: currentLocation?.longitude || 0,
                        mapUrl: payload.map,
                        timestampIso: new Date().toISOString(),
                        action: payload.action
                    }
                };
                
                console.log('[SMS][REQUEST] Request body:', requestBody);
                console.log('[SMS][REQUEST] Message length:', smsText.length, 'chars');
                console.log('[SMS][REQUEST] Destination (sanitized):', payload.emergencyPhone.replace(/\d(?=\d{4})/g, '*'));
                console.log('[SMS][REQUEST] Mode:', triggerType);
                
                // Create AbortController for timeout (30 seconds)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.error('[SMS][TIMEOUT] Request aborted after 30 seconds');
                }, 30000);
                
                // Send to backend with timeout
                const startTime = Date.now();
                console.log('[SMS][FETCH] Starting fetch request to:', SMS_API_URL);
                console.log('[SMS][FETCH] Request start time:', new Date(startTime).toISOString());
                
                let response;
                try {
                    response = await fetch(SMS_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    console.log('[SMS][FETCH] Fetch completed successfully');
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    
                    // Distinguish between different fetch errors
                    if (fetchError.name === 'AbortError') {
                        console.error('[SMS][ERROR] Request timeout after 30 seconds');
                        console.error('[SMS][DIAGNOSTIC] Check:');
                        console.error('[SMS][DIAGNOSTIC] 1. Lambda function is running and not timing out');
                        console.error('[SMS][DIAGNOSTIC] 2. Lambda has sufficient timeout configured (>30s)');
                        console.error('[SMS][DIAGNOSTIC] 3. Network connectivity is stable');
                        
                        const errorResult = {
                            ok: false,
                            provider: 'sns',
                            errorCode: 'TIMEOUT',
                            errorMessage: 'Request timed out after 30 seconds',
                            httpStatus: 0,
                            diagnostics: {
                                url: SMS_API_URL,
                                triggerType: triggerType,
                                timestamp: new Date().toISOString()
                            }
                        };
                        updateDeliveryStatus;
                        return { ok: false, error: 'Request timed out after 30 seconds', result: errorResult };
                        
                    } else if (fetchError.message.includes('Failed to fetch')) {
                        console.error('[SMS][ERROR] ‚ùå CORS or network error - Failed to fetch');
                        console.error('[SMS][DIAGNOSTIC] This usually means:');
                        console.error('[SMS][DIAGNOSTIC] 1. CORS headers missing from Lambda response');
                        console.error('[SMS][DIAGNOSTIC]    ‚Üí Lambda must return Access-Control-Allow-Origin: *');
                        console.error('[SMS][DIAGNOSTIC]    ‚Üí Lambda must return Access-Control-Allow-Methods: POST,OPTIONS');
                        console.error('[SMS][DIAGNOSTIC]    ‚Üí Lambda must return Access-Control-Allow-Headers: content-type');
                        console.error('[SMS][DIAGNOSTIC] 2. Lambda URL is incorrect or unreachable');
                        console.error('[SMS][DIAGNOSTIC]    ‚Üí Current URL:', SMS_API_URL);
                        console.error('[SMS][DIAGNOSTIC]    ‚Üí Verify Lambda Function URL is correct');
                        console.error('[SMS][DIAGNOSTIC] 3. OPTIONS preflight request failing');
                        console.error('[SMS][DIAGNOSTIC]    ‚Üí Check Network tab for OPTIONS request status');
                        console.error('[SMS][DIAGNOSTIC] 4. Network connectivity issue');
                        console.error('[SMS][DIAGNOSTIC]    ‚Üí Test Lambda URL in separate tab');
                        console.error('[SMS][ERROR] Full error:', fetchError);
                        console.error('[SMS][ERROR] Error name:', fetchError.name);
                        console.error('[SMS][ERROR] Error message:', fetchError.message);
                        
                        const errorResult = {
                            ok: false,
                            provider: 'sns',
                            errorCode: 'FETCH_EXCEPTION',
                            errorMessage: `Failed to fetch (likely CORS or network). Check console for diagnostics.`,
                            httpStatus: 0,
                            details: {
                                errorName: fetchError.name,
                                errorMessage: fetchError.message,
                                url: SMS_API_URL,
                                triggerType: triggerType,
                                timestamp: new Date().toISOString(),
                                diagnostics: [
                                    'Check Lambda CORS headers (Access-Control-Allow-Origin)',
                                    'Verify Lambda URL is correct and reachable',
                                    'Check Network tab for OPTIONS preflight status',
                                    'Test Lambda URL directly in browser'
                                ]
                            }
                        };
                        updateDeliveryStatus;
                        return { ok: false, error: errorResult.errorMessage, result: errorResult };
                        
                    } else {
                        console.error('[SMS][ERROR] Unexpected fetch error:', fetchError);
                        console.error('[SMS][ERROR] Error name:', fetchError.name);
                        console.error('[SMS][ERROR] Error message:', fetchError.message);
                        console.error('[SMS][ERROR] Error stack:', fetchError.stack);
                        
                        const errorResult = {
                            ok: false,
                            provider: 'sns',
                            errorCode: 'FETCH_EXCEPTION',
                            errorMessage: `Fetch error: ${fetchError.message}`,
                            httpStatus: 0,
                            details: {
                                errorName: fetchError.name,
                                errorMessage: fetchError.message,
                                url: SMS_API_URL,
                                triggerType: triggerType
                            }
                        };
                        updateDeliveryStatus;
                        return { ok: false, error: fetchError.message, result: errorResult };
                    }
                }
                
                const responseTime = Date.now() - startTime;
                console.log(`[SMS][RESPONSE] ‚úÖ HTTP ${response.status} in ${responseTime}ms`);
                console.log(`[SMS][RESPONSE] Status text: ${response.statusText}`);
                console.log(`[SMS][RESPONSE] Response URL: ${response.url}`);
                console.log(`[SMS][RESPONSE] Response type: ${response.type}`);
                
                // Log CORS headers for diagnostics
                const corsHeaders = {
                    'content-type': response.headers.get('content-type'),
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                    'access-control-allow-headers': response.headers.get('access-control-allow-headers')
                };
                console.log('[SMS][RESPONSE] CORS Headers:', corsHeaders);
                
                // Validate CORS headers
                if (!corsHeaders['access-control-allow-origin']) {
                    console.warn('[SMS][WARNING] Missing Access-Control-Allow-Origin header!');
                    console.warn('[SMS][WARNING] This may caUse issues in some browsers');
                }
                
                // Parse response
                let result;
                try {
                    const responseText = await response.text();
                    console.log('[SMS][RESPONSE] Raw body length:', responseText.length, 'bytes');
                    console.log('[SMS][RESPONSE] Raw body preview:', responseText.substring(0, 200));
                    result = JSON.parse(responseText);
                    console.log('[SMS][RESPONSE] Parsed JSON:', result);
                } catch (parseError) {
                    console.error('[SMS][ERROR] Failed to parse response JSON:', parseError);
                    console.error('[SMS][ERROR] Parse error message:', parseError.message);
                    
                    const errorResult = {
                        ok: false,
                        provider: 'sns',
                        errorCode: 'PARSE_ERROR',
                        errorMessage: `Failed to parse response: ${parseError.message}`,
                        httpStatus: response.status,
                        details: {
                            parseError: parseError.message,
                            responseStatus: response.status,
                            responseStatusText: response.statusText
                        }
                    };
                    updateDeliveryStatus;
                    return { ok: false, error: errorResult.errorMessage, result: errorResult };
                }
                
                // Check if response is successful (v4 API contract)
                // SUCCESS: HTTP 200 AND result.ok === true AND result.messageId exists
                if (result.ok === true && result.messageId) {
                    console.log('[SMS][SUCCESS] ‚úÖ SMS sent successfully');
                    console.log('[SMS][SUCCESS] Message ID:', result.messageId);
                    console.log('[SMS][SUCCESS] Provider:', result.provider);
                    console.log('[SMS][SUCCESS] Destination (masked):', result.toMasked);
                    console.log('[SMS][SUCCESS] HTTP status:', response.status);
                    console.log('[SMS][SUCCESS] Response time:', responseTime, 'ms');
                    
                    updateDeliveryStatus;
                    return { ok: true, messageId: result.messageId, result: result };
                    
                } else {
                    // FAILURE: Either non-200 HTTP status OR result.ok === false OR missing messageId
                    const errorMessage = result.errorMessage || result.error || `Backend returned ok:false or missing messageId`;
                    console.error('[SMS][ERROR] ‚ùå SMS sending failed');
                    console.error('[SMS][ERROR] Error message:', errorMessage);
                    console.error('[SMS][ERROR] HTTP status:', response.status);
                    console.error('[SMS][ERROR] result.ok:', result.ok);
                    console.error('[SMS][ERROR] result.messageId:', result.messageId);
                    console.error('[SMS][ERROR] Full response:', result);
                    
                    const errorResult = {
                        ok: false,
                        provider: result.provider || 'sns',
                        errorCode: result.errorCode || 'BACKEND_ERROR',
                        errorMessage: errorMessage,
                        httpStatus: response.status,
                        responseBody: result,
                        details: {
                            httpStatus: response.status,
                            httpStatusText: response.statusText,
                            resultOk: result.ok,
                            hasMessageId: !!result.messageId,
                            apiError: result.errorMessage || result.error,
                            apiErrorCode: result.errorCode
                        }
                    };
                    updateDeliveryStatus;
                    return { ok: false, error: errorMessage, result: errorResult };
                }
                
            } catch (error) {
                console.error('[SMS][ERROR] ‚ùå Unexpected error in sendSms():', error);
                console.error('[SMS][ERROR] Error name:', error.name);
                console.error('[SMS][ERROR] Error message:', error.message);
                console.error('[SMS][ERROR] Error stack:', error.stack);
                
                const errorResult = {
                    ok: false,
                    provider: 'sns',
                    errorCode: 'UNEXPECTED_ERROR',
                    errorMessage: `Unexpected error: ${error.message}`,
                    httpStatus: 0,
                    details: {
                        errorName: error.name,
                        errorMessage: error.message,
                        errorStack: error.stack
                    }
                };
                updateDeliveryStatus;
                return { ok: false, error: error.message, result: errorResult };
            }
        }
        
        /**
         * Update SMS delivery status in UI (v3 - Enhanced with all fields)
         */
        function updateDeliveryStatus {
            // Show delivery proof panel
            const panel = document.getElementById('smsDeliveryProofPanel');
            if (panel) panel.style.display = 'block';
            
            // Update status
            const statusEl = document.getElementById('sms-delivery-status');
            if (statusEl) {
                statusEl.textContent = status;
                statusEl.style.fontWeight = 'bold';
                
                // Color coding
                if (status === 'SENT') {
                    statusEl.style.color = '#28a745';
                } else if (status === 'SENDING') {
                    statusEl.style.color = '#ffc107';
                } else if (status === 'FAILED') {
                    statusEl.style.color = '#dc3545';
                } else {
                    statusEl.style.color = '#6c757d';
                }
            }
            
            // Update provider
            const providerEl = document.getElementById('sms-delivery-provider');
            if (providerEl) providerEl.textContent = apiResponse?.provider || 'SNS';
            
            // Update destination (masked)
            const destEl = document.getElementById('sms-delivery-destination');
            if (destEl) destEl.textContent = destination || '‚Äî';
            
            // Update timestamp
            const timeEl = document.getElementById('sms-delivery-timestamp');
            if (timeEl) timeEl.textContent = apiResponse?.timestamp || new Date().toISOString();
            
            // Update message ID
            const msgIdEl = document.getElementById('sms-delivery-message-id');
            if (msgIdEl) msgIdEl.textContent = apiResponse?.messageId || '‚Äî';
            
            // Update request ID
            const reqIdEl = document.getElementById('sms-delivery-request-id');
            if (reqIdEl) reqIdEl.textContent = apiResponse?.requestId || '‚Äî';
            
            // Update HTTP status
            const httpStatusEl = document.getElementById('sms-delivery-http-status');
            if (httpStatusEl) httpStatusEl.textContent = apiResponse?.httpStatus || (status === 'SENT' ? '200' : '‚Äî');
            
            // Show/hide success/error panels
            const errorDiv = document.getElementById('smsDeliveryError');
            const successDiv = document.getElementById('smsDeliverySuccess');
            const errorCodeEl = document.getElementById('smsDeliveryErrorCode');
            const errorTextEl = document.getElementById('smsDeliveryErrorText');
            const successMsgIdEl = document.getElementById('smsSuccessMessageId');
            
            if (status === 'SENT' && successDiv) {
                successDiv.style.display = 'block';
                if (successMsgIdEl) successMsgIdEl.textContent = apiResponse?.messageId || '‚Äî';
                if (errorDiv) errorDiv.style.display = 'none';
            } else if (status === 'FAILED' && errorDiv) {
                errorDiv.style.display = 'block';
                if (errorCodeEl) errorCodeEl.textContent = apiResponse?.errorCode || 'UNKNOWN_ERROR';
                if (errorTextEl) errorTextEl.textContent = apiResponse?.errorMessage || 'Unknown error occurred';
                if (successDiv) successDiv.style.display = 'none';
            } else {
                if (errorDiv) errorDiv.style.display = 'none';
                if (successDiv) successDiv.style.display = 'none';
            }
            
            console.log('[SMS][UI] Delivery status updated:', { 
                status, 
                destination, 
                triggerType,
                provider: apiResponse?.provider,
                messageId: apiResponse?.messageId,
                errorCode: apiResponse?.errorCode 
            });
        }
        
        /**
         * Send test SMS (manual trigger) - v3: NO RISK GATING
         * Works regardless of risk level for production reliability
         */
        async function sendTestSms() {
            console.log('[SMS][TEST] Manual test SMS triggered');
            
            // Check if Step 1 is complete
            if (!__ALLSENSES_STATE.configSaved) {
                alert('Please complete Step 1 (Configuration) first');
                return;
            }
            
            // Compose payload
            const payload = composeAlertPayload();
            
            // Validate phone number
            if (!payload.emergencyPhone || payload.emergencyPhone === 'Not provided') {
                alert('Please enter a valid emergency contact phone number in Step 1');
                return;
            }
            
            // E.164 validation
            const e164Pattern = /^\+[1-9]\d{6,14}$/;
            if (!e164Pattern.test(payload.emergencyPhone)) {
                alert('Invalid phone number format.\n\nMust be E.164 format (e.g., +573222063010 for Colombia).\n\nGot: ' + payload.emergencyPhone);
                return;
            }
            
            // Confirm with User
            const confirmed = confirm('Send test SMS to ' + payload.emergencyPhone + '?\n\nThis will send a real SMS message.\n\nNote: Works regardless of risk level (production safe).');
            if (!confirmed) {
                console.log('[SMS][TEST] User cancelled test SMS');
                return;
            }
            
            // Log manual test attempt
            console.log('[STEP5][ACTION] Sending TEST SMS to', payload.emergencyPhone, '(manual)');
            
            // Send SMS (isManualTest = true, bypasses risk gating)
            const result = await sendSms(payload, true);
            
            if (result.ok) {
                alert('‚úÖ Test SMS sent successfully!\n\nMessage ID: ' + result.messageId + '\n\nCheck your phone for delivery (5-30 seconds).');
            } else {
                alert('‚ùå Test SMS failed:\n\n' + result.error + '\n\nCheck Delivery Proof panel for details.');
            }
        }
        

        // FAILSAFE: Bind Step 1 button after DOM loads
        document.addEventListener("DOMContentLoaded", () => {
            const b = [...document.querySelectorAll("button")].find(x => x.innerText.includes("Complete Step 1"));
            if (!b) {
                console.warn("[STEP1] Complete Step 1 button not found");
                return;
            }
            b.addEventListener("click", (e) => {
                try {
                    console.log("[STEP1] click fired");
                    (window.completeStep1 || completeStep1)();
                    console.log("[STEP1] handler finished");
                } catch (err) {
                    console.error("[STEP1] error", err);
                    alert("Step 1 error ‚Äî check console");
                }
            }, { once: false });
            console.log("[STEP1] Failsafe binding installed");
        });

    </script>
</body>
</html>
