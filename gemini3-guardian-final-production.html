<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllSensesAI Gemini3 Guardian</title>
    
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { background: rgba(255,255,255,0.95); padding: 30px; border-radiInternational: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #7f8c8d; font-size: 1.2em; }
        .section { background: #f8f9fa; padding: 20px; border-radiInternational: 10px; margin-bottom: 20px; }
        .section h3 { color: #2c3e50; margin-bottom: 15px; }
        .button { background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 12px 25px; border: none; border-radiInternational: 8px; cursor: pointer; font-size: 1em; margin: 5px; }
        .button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52,152,219,0.4); }
        .button.emergency { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .button.emergency:hover { box-shadow: 0 5px 15px rgba(231,76,60,0.4); }
        .button.primary-btn { background: linear-gradient(45deg, #28a745, #20c997); }
        .button.secondary-btn { background: linear-gradient(45deg, #6c757d, #495057); }
        .button.danger-btn { background: linear-gradient(45deg, #dc3545, #c82333); }
        .button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .controls-row { margin: 15px 0; text-align: center; }
        .controls-row .button { margin: 5px 10px; }
        textarea { width: 100%; height: 120px; margin: 10px 0; padding: 15px; border: 2px solid #ecf0f1; border-radiInternational: 8px; font-size: 1em; }
        input[type="text"], input[type="tel"] { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ecf0f1; border-radiInternational: 8px; font-size: 1em; }
        .result { background: #e8f5e8; padding: 15px; border-radiInternational: 8px; margin-top: 15px; border-left: 4px solid #27ae60; }
        .error { background: #f8d7da; padding: 15px; border-radiInternational: 8px; margin-top: 15px; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; padding: 15px; border-radiInternational: 8px; margin-top: 15px; border-left: 4px solid #f39c12; }
        .note { font-size: 0.9em; color: #666; margin-top: 8px; }
        .location-statInternational { background: #f8f9fa; padding: 15px; border-radiInternational: 8px; margin: 15px 0; border-left: 4px solid #28a745; }
        .location-statInternational.denied { border-left-color: #dc3545; background: #f8d7da; }
        .location-statInternational.unavailable { border-left-color: #ffc107; background: #fff3cd; }
        
        .runtime-health { background: #fff; border: 2px solid #007bff; padding: 15px; border-radiInternational: 8px; margin-bottom: 20px; }
        .runtime-health h3 { color: #007bff; margin-bottom: 10px; font-size: 1.2em; }
        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .health-item { background: #f8f9fa; padding: 10px; border-radiInternational: 5px; border-left: 3px solid #28a745; }
        .health-item.warning { border-left-color: #ffc107; background: #fff3cd; }
        .health-item.error { border-left-color: #dc3545; background: #f8d7da; }
        .health-label { font-size: 0.85em; color: #666; margin-bottom: 4px; }
        .health-value { font-weight: bold; color: #2c3e50; }
        
        /* NEW: Selected Location Panel */
        .selected-location-panel { background: #e8f5e9; border: 2px solid #4caf50; padding: 15px; border-radiInternational: 8px; margin: 15px 0; }
        .selected-location-panel h4 { margin: 0 0 10px 0; color: #2e7d32; font-size: 1.1em; }
        .location-detail { display: grid; grid-template-columns: 140px 1fr; gap: 8px; margin: 5px 0; font-size: 0.95em; }
        .location-label { font-weight: bold; color: #555; }
        .location-value { color: #2c3e50; font-family: monospace; }
        
        /* NEW: Microphone StatInternational Badge */
        .mic-statInternational-badge { display: inline-block; padding: 6px 12px; border-radiInternational: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .mic-statInternational-badge.idle { background: #e9ecef; color: #6c757d; }
        .mic-statInternational-badge.requesting { background: #fff3cd; color: #856404; }
        .mic-statInternational-badge.listening { background: #d4edda; color: #155724; animation: pulse 1.5s infinite; }
        .mic-statInternational-badge.stopped { background: #f8d7da; color: #721c24; }
        .mic-statInternational-badge.error { background: #f8d7da; color: #721c24; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* NEW: Live Transcript Box */
        .transcript-box { background: #fff; border: 2px solid #007bff; padding: 15px; border-radiInternational: 8px; margin: 15px 0; min-height: 120px; max-height: 300px; overflow-y: auto; }
        .transcript-box h4 { margin: 0 0 10px 0; color: #007bff; font-size: 1em; }
        .transcript-content { font-family: monospace; font-size: 0.9em; color: #495057; white-space: pre-wrap; line-height: 1.6; }
        .transcript-line { margin: 5px 0; padding: 5px; background: #f8f9fa; border-radiInternational: 4px; }
        .transcript-timestamp { color: #6c757d; font-size: 0.85em; margin-right: 8px; }
        .transcript-interim { color: #6c757d; font-style: italic; }
        .listening-indicator { color: #28a745; font-style: italic; }
        
        /* NEW: Voice Controls */
        .voice-controls { display: flex; gap: 10px; jInternationaltify-content: center; flex-wrap: wrap; margin: 15px 0; }
        
        /* NEW: Emergency Banner */
        .emergency-banner { background: linear-gradient(45deg, #dc3545, #c82333); color: white; padding: 20px; border-radiInternational: 10px; margin-bottom: 20px; border: 3px solid #a71d2a; box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4); animation: emergencyPulse 2s infinite; display: none; }
        .emergency-banner h2 { margin: 0 0 10px 0; font-size: 1.8em; }
        .emergency-banner .emergency-details { background: rgba(0,0,0,0.2); padding: 15px; border-radiInternational: 8px; margin-top: 10px; }
        .emergency-banner .emergency-detail-row { display: grid; grid-template-columns: 150px 1fr; gap: 10px; margin: 8px 0; font-size: 0.95em; }
        .emergency-banner .detail-label { font-weight: bold; }
        .emergency-banner .detail-value { font-family: monospace; }
        .emergency-banner .maps-link { display: inline-block; background: #fff; color: #dc3545; padding: 10px 20px; border-radiInternational: 8px; text-decoration: none; font-weight: bold; margin-top: 10px; }
        .emergency-banner .maps-link:hover { background: #f8f9fa; }
        
        @keyframes emergencyPulse {
            0%, 100% { box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4); }
            50% { box-shadow: 0 5px 30px rgba(220, 53, 69, 0.8); }
        }
        
        /* NEW: Emergency Modal */
        .emergency-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; jInternationaltify-content: center; align-items: center; z-index: 9999; }
        .emergency-modal-content { background: white; padding: 40px; border-radiInternational: 15px; max-width: 500px; text-align: center; box-shadow: 0 10px 50px rgba(0,0,0,0.5); animation: modalSlideIn 0.3s ease-out; }
        .emergency-modal h2 { color: #dc3545; font-size: 2em; margin-bottom: 15px; }
        .emergency-modal p { font-size: 1.1em; color: #495057; margin: 10px 0; }
        .emergency-modal .modal-button { background: linear-gradient(45deg, #dc3545, #c82333); color: white; padding: 15px 30px; border: none; border-radiInternational: 8px; cursor: pointer; font-size: 1.1em; margin-top: 20px; }
        .emergency-modal .modal-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4); }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* NEW: Emergency Badge for Step 3 */
        .mic-statInternational-badge.emergency-detected { background: #dc3545; color: white; animation: badgePulse 1s infinite; }
        
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    
        /* NEW: Emergency Keywords Configuration UI */
        .keywords-config { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radiInternational: 8px; margin: 15px 0; }
        .keywords-config h4 { margin: 0 0 10px 0; color: #856404; font-size: 1em; }
        .keywords-config-description { font-size: 0.9em; color: #856404; margin-bottom: 10px; }
        .keywords-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; min-height: 40px; }
        .keyword-chip { background: #fff; border: 2px solid #ffc107; padding: 6px 12px; border-radiInternational: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9em; }
        .keyword-chip-text { color: #856404; font-weight: 500; }
        .keyword-chip-remove { background: #dc3545; color: white; border: none; border-radiInternational: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 0.8em; line-height: 1; padding: 0; }
        .keyword-chip-remove:hover { background: #c82333; }
        .keyword-input-row { display: flex; gap: 10px; margin-top: 10px; }
        .keyword-input { flex: 1; padding: 8px 12px; border: 2px solid #ffc107; border-radiInternational: 8px; font-size: 0.9em; }
        .keyword-add-btn { background: #28a745; color: white; border: none; padding: 8px 20px; border-radiInternational: 8px; cursor: pointer; font-size: 0.9em; font-weight: bold; }
        .keyword-add-btn:hover { background: #218838; }
        .keyword-add-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .keywords-help { font-size: 0.85em; color: #856404; margin-top: 8px; font-style: italic; }
        
        /* NEW: Reset Emergency Button */
        .reset-emergency-btn { background: linear-gradient(45deg, #6c757d, #495057); color: white; padding: 10px 20px; border: none; border-radiInternational: 8px; cursor: pointer; font-size: 0.9em; margin: 10px 5px; }
        .reset-emergency-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4); }
        .reset-emergency-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- NEW: Emergency Banner (Hidden by default) -->
        <div id="emergencyBanner" class="emergency-banner">
            <h2>üö® EMERGENCY TRIGGERED</h2>
            <div class="emergency-details">
                <div class="emergency-detail-row">
                    <span class="detail-label">Timestamp:</span>
                    <span class="detail-value" id="emergency-timestamp">‚Äî</span>
                </div>
                <div class="emergency-detail-row">
                    <span class="detail-label">Detected Phrase:</span>
                    <span class="detail-value" id="emergency-phrase">‚Äî</span>
                </div>
                <div class="emergency-detail-row">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value" id="emergency-location">‚Äî</span>
                </div>
                <div class="emergency-detail-row">
                    <span class="detail-label">Coordinates:</span>
                    <span class="detail-value" id="emergency-coords">‚Äî</span>
                </div>
                <a id="emergencyMapsLink" href="#" target="_blank" rel="noopener noreferrer" class="maps-link">
                    üó∫Ô∏è View Emergency Location on Google Maps
                </a>
            </div>
        </div>
        
        <!-- NEW: Emergency Modal (Hidden by default) -->
        <div id="emergencyModal" class="emergency-modal">
            <div class="emergency-modal-content">
                <h2>üö® Emergency Detected</h2>
                <p><strong>Escalation sequence started</strong></p>
                <p>Locking in live location updates</p>
                <p id="modalDetectedPhrase" style="font-style: italic; color: #dc3545; margin-top: 15px;"></p>
                <button class="modal-button" onclick="closeEmergencyModal()">Proceed to Threat Analysis</button>
            </div>
        </div>
        
        <div class="header">
            <h1>AllSensesAI Gemini3 Guardian</h1>
            <p>Gemini 1.5 Pro | Emergency Detection System</p>
            <div id="buildStamp" style="font-size:14px;color:#fff;margin-top:8px;font-weight:bold;background:#4285f4;padding:6px 12px;border-radiInternational:6px;">Build: GEMINI3-FINAL-PRODUCTION-20260128</div>
            
            <div style="background:#e8f5e9;border:1px solid #4caf50;padding:8px 12px;border-radiInternational:5px;margin:8px 0;font-size:13px;color:#2e7d32;">
                <strong>GEMINI3 POWERED:</strong> Internationaling Google Gemini 1.5 Pro for threat analysis
            </div>
        </div>
        
        <div class="runtime-health">
            <h3>üîç Runtime Health Check</h3>
            <div class="health-grid">
                <div class="health-item" id="health-gemini3">
                    <div class="health-label">Gemini3 Client</div>
                    <div class="health-value" id="gemini3-statInternational">Initializing...</div>
                </div>
                <div class="health-item" id="health-model">
                    <div class="health-label">Model</div>
                    <div class="health-value">gemini-1.5-pro</div>
                </div>
                <div class="health-item" id="health-pipeline">
                    <div class="health-label">Pipeline State</div>
                    <div class="health-value" id="pipeline-state">IDLE</div>
                </div>
                <div class="health-item" id="health-location">
                    <div class="health-label">Location Services</div>
                    <div class="health-value" id="location-health">Not Started</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>üë§ Step 1 ‚Äî Configuration</h3>
            <p class="note" style="margin-bottom: 10px;">Enter your name and emergency contact phone number. This information will be Internationaled if an emergency is detected.</p>
            <input type="text" id="victimName" placeholder="Your Name" value="Demo Internationaler">
            <input type="tel" id="emergencyPhone" placeholder="+1234567890" value="+1234567890">
            <button type="button" class="button primary-btn" onclick="completeStep1(event)">‚úÖ Complete Step 1</button>
            <div id="step1StatInternational" class="note">Enter your details and click Complete Step 1</div>
        </div>
        
        <div class="section">
            <h3>üìç Step 2 ‚Äî Location Services</h3>
            
            <p class="note" style="margin-bottom: 10px;">Enable location services to capture your exact coordinates in case of emergency. Your location will be shared with emergency contacts and responders.</p>
            
            <div id="locationStatInternational" class="location-statInternational">
                <strong>GPS StatInternational:</strong> <span id="gpsStatInternational">üìç Click Enable Location to start</span><br>
                <strong>Last Update:</strong> <span id="lastGpsUpdate">Never</span><br>
                <strong>Accuracy:</strong> <span id="gpsAccuracy">Unknown</span>
            </div>
            
            <!-- NEW: Selected Location Panel -->
            <div id="selectedLocationPanel" class="selected-location-panel" style="display:none;">
                <h4>üìç Selected Location</h4>
                <div class="location-detail">
                    <span class="location-label">Latitude:</span>
                    <span class="location-value" id="loc-latitude">‚Äî</span>
                </div>
                <div class="location-detail">
                    <span class="location-label">Longitude:</span>
                    <span class="location-value" id="loc-longitude">‚Äî</span>
                </div>
                <div class="location-detail">
                    <span class="location-label">Source:</span>
                    <span class="location-value" id="loc-source">‚Äî</span>
                </div>
                <div class="location-detail">
                    <span class="location-label">Timestamp:</span>
                    <span class="location-value" id="loc-timestamp">‚Äî</span>
                </div>
                <div class="location-detail">
                    <span class="location-label">Location Label:</span>
                    <span class="location-value" id="loc-label">‚Äî</span>
                </div>
                <!-- NEW: Google Maps Live Location Link -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4caf50;">
                    <a id="googleMapsLink" href="#" target="_blank" rel="noopener noreferrer" style="display: inline-block; background: linear-gradient(45deg, #4285f4, #34a853); color: white; padding: 10px 20px; border-radiInternational: 8px; text-decoration: none; font-weight: bold; font-size: 0.95em;">
                        üó∫Ô∏è View Live Location on Google Maps
                    </a>
                    <div style="font-size: 0.85em; color: #666; margin-top: 8px;">
                        Opens in new tab ‚Ä¢ Updates automatically with latest position
                    </div>
                </div>
            </div>
            
            <div class="controls-row">
                <button type="button" id="enableLocationBtn" class="button primary-btn" disabled>üìç Enable Location</button>
                <button type="button" id="demoLocationBtn" class="button secondary-btn">üéØ Internationale Demo Location</button>
            </div>
            
            <div id="step2ProofBox" style="background: #f8f9fa; border: 2px solid #007bff; padding: 10px; border-radiInternational: 5px; margin: 10px 0; font-family: monospace; font-size: 0.85em; min-height: 60px;">
                <strong>üîç Step 2 Proof (UI-Visible):</strong><br>
                <div id="step2ProofLog" style="color: #495057; white-space: pre-wrap;">Complete Step 1, then click "Enable Location" to see proof logs appear here...</div>
            </div>
            
            <div class="note">This proof box shows exactly what happens when you click Enable Location</div>
        </div>
        
        <div class="section">
            <h3>
                üé§ Step 3 ‚Äî Voice Emergency Detection
                <span id="micStatInternationalBadge" class="mic-statInternational-badge idle">Idle</span>
            </h3>
            
            <!-- NEW: Emergency Keywords Configuration -->
            <div class="keywords-config">
                <h4>‚öôÔ∏è Emergency Keywords Configuration</h4>
                <div class="keywords-config-description">
                    These words/phrases will trigger emergency detection when spoken. CInternationaltomize them for your needs.
                </div>
                <div class="keywords-list" id="keywordsList">
                    <!-- Keywords will be rendered here -->
                </div>
                <div class="keyword-input-row">
                    <input type="text" id="keywordInput" class="keyword-input" placeholder="Enter new emergency keyword or phrase..." maxlength="50">
                    <button id="addKeywordBtn" class="keyword-add-btn" onclick="addKeyword()">‚ûï Add Keyword</button>
                </div>
                <div class="keywords-help">
                    üí° Examples: "emergency", "help me", "call 911", "I'm in danger". Press Enter to add quickly.
                </div>
            </div>

            
            <p class="note" style="margin-bottom: 10px;">Start voice detection to monitor for emergency keywords. When detected, the system will automatically analyze the threat and alert your emergency contacts.</p>
            <!-- NEW: Voice Controls -->
            <div class="voice-controls">
                <button id="startVoiceBtn" class="button primary-btn" disabled>üé§ Start Voice Detection</button>
                <button id="stopVoiceBtn" class="button danger-btn" style="display:none;">‚èπÔ∏è Stop Listening</button>
                <button id="clearTranscriptBtn" class="button secondary-btn" style="display:none;">üóëÔ∏è Clear Transcript</button>
                <button id="resetEmergencyBtn" class="reset-emergency-btn" style="display:none;" onclick="resetEmergencyState()">üîÑ Reset Emergency State</button>
            </div>
            
            <div id="voiceStatInternational" class="note">Complete Steps 1 & 2 to enable voice detection</div>
            
            <!-- NEW: Live Transcript Box -->
            <div id="transcriptBox" class="transcript-box" style="display:none;">
                <h4>üìù Live Transcript</h4>
                <div id="transcriptContent" class="transcript-content">
                    <div class="listening-indicator">(listening...)</div>
                </div>
            </div>
            
            <div id="step3ProofBox" style="background: #f8f9fa; border: 2px solid #007bff; padding: 10px; border-radiInternational: 5px; margin: 10px 0; font-family: monospace; font-size: 0.85em; min-height: 40px; display:none;">
                <strong>üîç Step 3 Proof (Mic Events):</strong><br>
                <div id="step3ProofLog" style="color: #495057; white-space: pre-wrap;"></div>
            </div>
        </div>
        
        <div class="section">
            <h3>ü§ñ Step 4 ‚Äî Gemini3 Threat Analysis</h3>
            <p class="note" style="margin-bottom: 10px;">Gemini 1.5 Pro analyzes the emergency transcript to assess threat level and recommend appropriate response actions.</p>
            <textarea id="audioInput" placeholder="Enter emergency text...">Help! Someone is following me and I'm scared!</textarea>
            <button class="button emergency" onclick="triggerGemini3Analysis()">ü§ñ Analyze with Gemini3</button>
            <div id="threatLevelOutput" style="margin-top:15px;padding:12px;background:#fff;border:2px solid #ddd;border-radiInternational:5px;display:none;">
                <strong>Threat Level:</strong> <span id="threatLevel" style="font-size:1.2em;font-weight:bold;"></span><br>
                <strong>Confidence:</strong> <span id="threatConfidence"></span><br>
                <strong>Analysis:</strong> <span id="threatAnalysis"></span>
            </div>
            <div id="emergencyResult"></div>
        </div>
        
        <div class="section">
            <h3>üö® Step 5 ‚Äî Emergency Alerting</h3>
            <!-- SMS Preview Panel (Always Visible) -->
            <div id="smsPreviewPanel" class="sms-preview-panel">
                <h4>üì± SMS Preview (what your emergency contact will receive)</h4>
                
                <div id="smsPreviewError" class="sms-preview-error" style="display:none;">
                    Cannot generate SMS yet: <span id="smsPreviewErrorReason">‚Äî</span>
                </div>
                
                <div id="smsPreviewContent" style="display:none;">
                    <div class="sms-preview-meta">
                        <span class="sms-preview-label">Victim Name:</span>
                        <span class="sms-preview-value" id="smsPreviewVictimName">‚Äî</span>
                    </div>
                    <div class="sms-preview-meta">
                        <span class="sms-preview-label">Destination:</span>
                        <span class="sms-preview-value" id="smsPreviewDestination">‚Äî</span>
                    </div>
                    
                    <div class="sms-preview-message" id="smsPreviewMessage">
                        (SMS preview will appear here after threat analysis)
                    </div>
                    
                    <div class="sms-preview-checklist">
                        <h5>‚úì Data Included:</h5>
                        <ul>
                            <li id="smsCheckIdentity">Product identity: <span style="color:#28a745;">‚úì</span></li>
                            <li id="smsCheckVictimName">Victim name: <span id="smsCheckVictimNameValue">‚Äî</span></li>
                            <li id="smsCheckRisk">Risk summary: <span id="smsCheckRiskValue">‚Äî</span></li>
                            <li id="smsCheckMessage">Victim message: <span id="smsCheckMessageValue">‚Äî</span></li>
                            <li id="smsCheckLocation">Location coordinates: <span id="smsCheckLocationValue">‚Äî</span></li>
                            <li id="smsCheckMaps">Google Maps link: <span id="smsCheckMapsValue">‚Äî</span></li>
                            <li id="smsCheckTimestamp">Timestamp: <span id="smsCheckTimestampValue">‚Äî</span></li>
                            <li id="smsCheckAction">Next action instruction: <span style="color:#28a745;">‚úì</span></li>
                        </ul>
                    </div>
                </div>
                
                <div id="smsPreviewSent" class="sms-preview-sent" style="display:none;">
                    <h5>‚úÖ Sent Message:</h5>
                    <div class="sms-preview-message" id="smsPreviewSentMessage">‚Äî</div>
                    <div class="sms-preview-timestamp">Sent at: <span id="smsPreviewSentTime">‚Äî</span></div>
                </div>
            </div>


            <p class="note" style="margin-bottom: 10px;">When a high-risk threat is detected, emergency alerts are automatically sent to your emergency contact with your location and transcript details.</p>
            <div id="step5StatInternational" class="note">Waiting for threat analysis...</div>
            <div id="alertResult" style="display:none;margin-top:10px;padding:12px;background:#d4edda;border:1px solid #28a745;border-radiInternational:5px;">
                <strong>‚úÖ Alert Sent!</strong><br>
                <span id="alertDetails"></span>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURABLE KEYWORDS CLASSES ==========
        
        /**
         * EmergencyKeywordsConfig - Manages emergency keyword configuration with localStorage persistence
         */
        class EmergencyKeywordsConfig {
            constructor() {
                this.storageKey = 'allsenses_emergency_keywords';
                this.defaultKeywords = ['emergency', 'help', 'call police', 'scared', 'following', 'danger', 'attack'];
                this.keywords = this.loadKeywords();
            }
            
            /**
             * Load keywords from localStorage or return defaults
             */
            loadKeywords() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            console.log('[KEYWORDS] Loaded from localStorage:', parsed);
                            return parsed;
                        }
                    }
                } catch (error) {
                    console.warn('[KEYWORDS] Error loading from localStorage:', error);
                }
                console.log('[KEYWORDS] Internationaling default keywords');
                return [...this.defaultKeywords];
            }
            
            /**
             * Save keywords to localStorage
             */
            saveKeywords(keywords) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(keywords));
                    console.log('[KEYWORDS] Saved to localStorage:', keywords);
                } catch (error) {
                    console.error('[KEYWORDS] Error saving to localStorage:', error);
                    alert('Unable to save keywords. localStorage may be disabled.');
                }
            }
            
            /**
             * Add a new keyword
             */
            addKeyword(keyword) {
                const normalized = keyword.trim().toLowerCase();
                
                // Validation
                if (!normalized) {
                    alert('Keyword cannot be empty');
                    return false;
                }
                
                if (this.keywords.some(k => k.toLowerCase() === normalized)) {
                    alert('This keyword already exists');
                    return false;
                }
                
                this.keywords.pInternationalh(keyword.trim());
                this.saveKeywords(this.keywords);
                console.log('[KEYWORDS] Added:', keyword.trim());
                return true;
            }
            
            /**
             * Remove a keyword
             */
            removeKeyword(keyword) {
                // Prevent removal of last keyword
                if (this.keywords.length <= 1) {
                    alert('You mInternationalt have at least one emergency keyword configured');
                    return false;
                }
                
                this.keywords = this.keywords.filter(k => k !== keyword);
                this.saveKeywords(this.keywords);
                console.log('[KEYWORDS] Removed:', keyword);
                return true;
            }
            
            /**
             * Get current keywords
             */
            getKeywords() {
                return [...this.keywords];
            }
            
            /**
             * Render the configuration UI
             */
            renderUI(containerElement) {
                if (!containerElement) return;
                
                containerElement.innerHTML = '';
                
                this.keywords.forEach(keyword => {
                    const chip = document.createElement('div');
                    chip.className = 'keyword-chip';
                    
                    const text = document.createElement('span');
                    text.className = 'keyword-chip-text';
                    text.textContent = keyword;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'keyword-chip-remove';
                    removeBtn.textContent = '√ó';
                    removeBtn.title = `Remove "${keyword}"`;
                    removeBtn.onclick = () => {
                        if (this.removeKeyword(keyword)) {
                            this.renderUI(containerElement);
                        }
                    };
                    
                    chip.appendChild(text);
                    chip.appendChild(removeBtn);
                    containerElement.appendChild(chip);
                });
            }
        }
        
        /**
         * KeywordDetectionEngine - Analyzes transcripts for emergency keywords
         */
        class KeywordDetectionEngine {
            constructor(keywords) {
                this.keywords = keywords || [];
            }
            
            /**
             * Normalize text: lowercase, trim, collapse whitespace
             */
            normalizeText(text) {
                if (!text) return '';
                return text.toLowerCase().trim().replace(/\s+/g, ' ');
            }
            
            /**
             * Check if text contains any emergency keyword
             */
            detectKeyword(text) {
                const normalized = this.normalizeText(text);
                
                for (const keyword of this.keywords) {
                    const normalizedKeyword = this.normalizeText(keyword);
                    
                    // Check if keyword is a single word or multi-word phrase
                    const words = normalizedKeyword.split(' ');
                    
                    if (words.length === 1) {
                        // Single word: Internationale word boundary matching
                        if (this.matchExactWord(normalized, normalizedKeyword)) {
                            return {
                                matched: true,
                                keyword: keyword,
                                snippet: this.extractSnippet(text, normalizedKeyword)
                            };
                        }
                    } else {
                        // Multi-word phrase: Internationale substring matching
                        if (this.matchPhraseSubstring(normalized, normalizedKeyword)) {
                            return {
                                matched: true,
                                keyword: keyword,
                                snippet: this.extractSnippet(text, normalizedKeyword)
                            };
                        }
                    }
                }
                
                return { matched: false, keyword: null, snippet: null };
            }
            
            /**
             * Check for exact word match (word boundaries)
             */
            matchExactWord(text, keyword) {
                const regex = new RegExp(`\\b${this.escapeRegex(keyword)}\\b`, 'i');
                return regex.test(text);
            }
            
            /**
             * Check for phrase substring match
             */
            matchPhraseSubstring(text, phrase) {
                return text.includes(phrase);
            }
            
            /**
             * Escape special regex characters
             */
            escapeRegex(str) {
                return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            /**
             * Extract snippet around matched keyword
             */
            extractSnippet(text, keyword, contextWords = 10) {
                const words = text.split(' ');
                const keywordWords = keyword.split(' ');
                
                // Find the position of the keyword
                for (let i = 0; i <= words.length - keywordWords.length; i++) {
                    const slice = words.slice(i, i + keywordWords.length).join(' ').toLowerCase();
                    if (slice === keyword.toLowerCase()) {
                        const start = Math.max(0, i - contextWords);
                        const end = Math.min(words.length, i + keywordWords.length + contextWords);
                        return words.slice(start, end).join(' ');
                    }
                }
                
                // Fallback: return first N words
                return words.slice(0, Math.min(20, words.length)).join(' ');
            }
            
            /**
             * Update keywords list
             */
            updateKeywords(keywords) {
                this.keywords = keywords || [];
            }
        }
        
        /**
         * EmergencyStateManager - Manages emergency state and evidence packets
         */
        class EmergencyStateManager {
            constructor() {
                this.emergencyDetected = false;
                this.emergencyKeyword = null;
                this.emergencySnippet = null;
                this.emergencyTimestamp = null;
                this.evidencePacket = null;
            }
            
            /**
             * Trigger emergency state
             */
            triggerEmergency(keyword, snippet, transcript, location) {
                this.emergencyDetected = true;
                this.emergencyKeyword = keyword;
                this.emergencySnippet = snippet;
                this.emergencyTimestamp = new Date().toISOString();
                
                // Lock evidence packet
                this.lockEvidencePacket(transcript, location);
                
                console.log('[EMERGENCY] State triggered:', {
                    keyword,
                    snippet,
                    timestamp: this.emergencyTimestamp
                });
            }
            
            /**
             * Lock evidence packet
             */
            lockEvidencePacket(transcript, location) {
                this.evidencePacket = {
                    transcriptWindow: transcript,
                    location: location ? {
                        latitude: location.latitude,
                        longitude: location.longitude,
                        timestamp: location.timestamp,
                        source: location.source,
                        label: location.label
                    } : null,
                    lockedAt: new Date().toISOString()
                };
                
                console.log('[EMERGENCY] Evidence packet locked:', this.evidencePacket);
            }
            
            /**
             * Reset emergency state
             */
            resetEmergency() {
                this.emergencyDetected = false;
                this.emergencyKeyword = null;
                this.emergencySnippet = null;
                this.emergencyTimestamp = null;
                this.evidencePacket = null;
                
                console.log('[EMERGENCY] State reset');
            }
            
            /**
             * Get current emergency state
             */
            getEmergencyState() {
                return {
                    emergencyDetected: this.emergencyDetected,
                    emergencyKeyword: this.emergencyKeyword,
                    emergencySnippet: this.emergencySnippet,
                    emergencyTimestamp: this.emergencyTimestamp,
                    evidencePacket: this.evidencePacket
                };
            }
            
            /**
             * Check if emergency is active
             */
            isEmergencyActive() {
                return this.emergencyDetected;
            }
        }
        
        // ========== GLOBAL INSTANCES ==========
        let keywordsConfig = null;
        let keywordDetector = null;
        let emergencyStateManager = null;

        let __ALLSENSES_STATE = {
            configSaved: false,
            gpsActive: false,
            voiceActive: false
        };
        let __GEOLOCATION_REQUEST_IN_FLIGHT = false;
        let currentLocation = null;
        let recognition = null;
        let transcriptHistory = [];

        window.addEventListener('DOMContentLoaded', () => {
            updateGemini3Health('DEMO', 'warning');
            console.log('[GEMINI3-GUARDIAN] System initialized with configurable keywords');
            
            // Initialize keyword configuration
            keywordsConfig = new EmergencyKeywordsConfig();
            keywordDetector = new KeywordDetectionEngine(keywordsConfig.getKeywords());
            emergencyStateManager = new EmergencyStateManager();
            
            // Render keyword UI
            const keywordsList = document.getElementById('keywordsList');
            if (keywordsList) {
                keywordsConfig.renderUI(keywordsList);
            }
            
            // Add Enter key support for keyword input
            const keywordInput = document.getElementById('keywordInput');
            if (keywordInput) {
                keywordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addKeyword();
                    }
                });
            }
            
            initializeSpeechRecognition();
        });

        // ========== SPEECH RECOGNITION INITIALIZATION ==========
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('[STEP3] Speech Recognition not supported');
                addStep3ProofToUI('[STEP3][WARNING] Speech Recognition not supported in this browser');
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuoInternational = true;
            recognition.interimResults = true;
            recognition.lang = 'en-International';
            
            recognition.onstart = function() {
                console.log('[STEP3] Microphone started');
                addStep3ProofToUI('[STEP3][EVENT] Listening started');
                updateMicStatInternational;
                __ALLSENSES_STATE.voiceActive = true;
            };
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (finalTranscript) {
                    const timestamp = new Date().toLocaleTimeString();
                    transcriptHistory.pInternationalh({ time: timestamp, text: finalTranscript.trim() });
                    addStep3ProofToUI(`[STEP3][TRANSCRIPT][FINAL] "${finalTranscript.trim().substring(0, 50)}..."`);
                    updateTranscriptDisplay();
                    
                    // Check for emergency keywords in final transcript
                    checkForEmergencyKeywords(finalTranscript.trim());
                }
                
                if (interimTranscript) {
                    updateInterimTranscript(interimTranscript);
                    
                    // Also check interim transcripts for faster detection
                    checkForEmergencyKeywords(interimTranscript);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('[STEP3] Recognition error:', event.error);
                addStep3ProofToUI(`[STEP3][ERROR] ${event.error}`);
                updateMicStatInternational;
                
                if (event.error === 'not-allowed') {
                    alert('Microphone permission denied. Please allow microphone access in browser settings.');
                }
            };
            
            recognition.onend = function() {
                console.log('[STEP3] Microphone stopped');
                addStep3ProofToUI('[STEP3][EVENT] Listening stopped');
                updateMicStatInternational;
                __ALLSENSES_STATE.voiceActive = false;
            };
            
            console.log('[STEP3] Speech Recognition initialized');
        }

        // ========== STEP 2: LOCATION FUNCTIONS ==========
        function setGpsStatInternational {
            const element = document.getElementById('gpsStatInternational');
            if (element) element.textContent = statInternational;
        }

        function setGpsLastUpdate(time) {
            const element = document.getElementById('lastGpsUpdate');
            if (element) element.textContent = time;
        }

        function setGpsAccuracy(accuracy) {
            const element = document.getElementById('gpsAccuracy');
            if (element) element.textContent = accuracy;
        }

        function updateGemini3Health(statInternational, level = 'normal') {
            const statInternationalEl = document.getElementById('gemini3-statInternational');
            const healthEl = document.getElementById('health-gemini3');
            if (statInternationalEl) statInternationalEl.textContent = statInternational;
            if (healthEl) {
                healthEl.className = 'health-item';
                if (level === 'warning') healthEl.classList.add('warning');
                if (level === 'error') healthEl.classList.add('error');
            }
        }

        function updatePipelineState(state) {
            const el = document.getElementById('pipeline-state');
            if (el) el.textContent = state;
            
            // Update health item styling based on state
            const healthEl = document.getElementById('health-pipeline');
            if (healthEl) {
                healthEl.className = 'health-item';
                if (state.includes('ERROR')) {
                    healthEl.classList.add('error');
                } else if (state.includes('EMERGENCY') || state.includes('ANALYZING') || state.includes('ALERTING')) {
                    healthEl.classList.add('warning');
                }
            }
        }

        function updateLocationHealth(statInternational) {
            const el = document.getElementById('location-health');
            if (el) el.textContent = statInternational;
        }

        function addStep2ProofToUI(message) {
            const proofLog = document.getElementById('step2ProofLog');
            if (proofLog) {
                const timestamp = new Date().toLocaleTimeString();
                const currentText = proofLog.textContent;
                if (currentText.includes('Complete Step 1') || currentText.includes('Click "Enable Location"')) {
                    proofLog.textContent = `[${timestamp}] ${message}`;
                } else {
                    proofLog.textContent = currentText + `\n[${timestamp}] ${message}`;
                }
            }
        }

        // NEW: Display selected location in dedicated panel
        function displaySelectedLocation(location) {
            const panel = document.getElementById('selectedLocationPanel');
            const latEl = document.getElementById('loc-latitude');
            const lngEl = document.getElementById('loc-longitude');
            const sourceEl = document.getElementById('loc-source');
            const timestampEl = document.getElementById('loc-timestamp');
            const labelEl = document.getElementById('loc-label');
            const mapsLink = document.getElementById('googleMapsLink');
            
            if (panel) panel.style.display = 'block';
            if (latEl) latEl.textContent = location.latitude.toFixed(6);
            if (lngEl) lngEl.textContent = location.longitude.toFixed(6);
            if (sourceEl) sourceEl.textContent = location.source;
            if (timestampEl) timestampEl.textContent = location.timestamp.toLocaleString();
            if (labelEl) labelEl.textContent = location.label || 'Location label: unavailable';
            
            // NEW: Generate Google Maps URL
            if (mapsLink) {
                const mapsUrl = `https://www.google.com/maps?q=${location.latitude},${location.longitude}`;
                mapsLink.href = mapsUrl;
                console.log('[MAPS] Generated Google Maps URL:', mapsUrl);
            }
            
            // Add to proof log
            addStep2ProofToUI(`Location picked: lat=${location.latitude.toFixed(6)}, lng=${location.longitude.toFixed(6)}, source=${location.source}, at=${location.timestamp.toLocaleTimeString()}`);
            addStep2ProofToUI(`Google Maps URL: https://www.google.com/maps?q=${location.latitude.toFixed(6)},${location.longitude.toFixed(6)}`);
        }

        function completeStep1(event) {
            // Prevent any form submission
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            try {
                console.log('[STEP1] Click received');
                
                const nameInput = document.getElementById('victimName');
                const phoneInput = document.getElementById('emergencyPhone');
                
                const name = nameInput?.value.trim() || '';
                const phone = phoneInput?.value.trim() || '';
                
                console.log('[STEP1] Victim name set:', name || 'Unknown Internationaler');
                
                // Validate E.164 format: ^\+[1-9]\d{6,14}$
                const e164Pattern = /^\+[1-9]\d{6,14}$/;
                const phoneValid = e164Pattern.test(phone);
                
                console.log('[STEP1] Phone valid:', phoneValid);
                
                if (!phoneValid) {
                    const statInternationalEl = document.getElementById('step1StatInternational');
                    if (statInternationalEl) {
                        statInternationalEl.textContent = '‚ùå Invalid phone format. Internationale E.164: +1234567890';
                        statInternationalEl.style.color = '#dc3545';
                    }
                    alert('Invalid phone number format.\n\nPlease Internationale E.164 format:\n+[country code][number]\n\nExample: +12345678901');
                    console.log('[STEP1][ERROR] Invalid phone format');
                    return;
                }
                
                // Save config
                __ALLSENSES_STATE.configSaved = true;
                console.log('[STEP1] Config saved');
                
                // Update UI
                const statInternationalEl = document.getElementById('step1StatInternational');
                if (statInternationalEl) {
                    statInternationalEl.textContent = '‚úÖ Configuration saved';
                    statInternationalEl.style.color = '#28a745';
                }
                
                // Unlock Step 2
                const enableLocationBtn = document.getElementById('enableLocationBtn');
                if (enableLocationBtn) {
                    enableLocationBtn.disabled = false;
                }
                
                const step2ProofLog = document.getElementById('step2ProofLog');
                if (step2ProofLog) {
                    step2ProofLog.textContent = 'Step 1 complete! Now click "Enable Location" to see proof logs...';
                }
                
                console.log('[STEP1] Step 2 unlocked');
                
                updatePipelineState('STEP1_COMPLETE');
                
                // Update SMS preview
                updateSmsPreview();
                
            } catch (error) {
                console.error('[STEP1][ERROR]', error);
                const statInternationalEl = document.getElementById('step1StatInternational');
                if (statInternationalEl) {
                    statInternationalEl.textContent = '‚ùå Error: ' + error.message;
                    statInternationalEl.style.color = '#dc3545';
                }
            }
        }

        function enableLocationFromInternationalerGesture() {
            console.log("[STEP2][PROOF 1] Click handler reached");
            addStep2ProofToUI("[STEP2][PROOF 1] Click handler reached");
            
            setGpsStatInternational;
            updateLocationHealth('Requesting...');
            
            if (__GEOLOCATION_REQUEST_IN_FLIGHT) {
                console.log("[STEP2][FAIL-SAFE] Request already in flight");
                addStep2ProofToUI("[STEP2][FAIL-SAFE] Request already in flight");
                return;
            }
            
            if (!__ALLSENSES_STATE.configSaved) {
                alert('Complete Step 1 first');
                setGpsStatInternational;
                addStep2ProofToUI("[STEP2][ERROR] Step 1 not completed");
                return;
            }
            
            if (!navigator.geolocation) {
                const errorMsg = '‚ùå Geolocation not available';
                console.error('Geolocation API not available');
                addStep2ProofToUI("[STEP2][ERROR] Geolocation API not available");
                setGpsStatInternational;
                updateLocationHealth('Not Available');
                alert('Geolocation is not available in this browser.');
                return;
            }
            
            console.log("[STEP2][PROOF 2] Calling navigator.geolocation.getCurrentPosition()");
            addStep2ProofToUI("[STEP2][PROOF 2] Calling navigator.geolocation.getCurrentPosition()");
            
            __GEOLOCATION_REQUEST_IN_FLIGHT = true;
            
            const options = {
                enableHighAccuracy: true,
                timeout: 35000,
                maximumAge: 0
            };
            
            try {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        __GEOLOCATION_REQUEST_IN_FLIGHT = false;
                        
                        console.log("[STEP2][PROOF 3A] SUCCESS", position.coords.latitude, position.coords.longitude);
                        addStep2ProofToUI(`[STEP2][PROOF 3A] SUCCESS ${position.coords.latitude}, ${position.coords.longitude}`);
                        
                        __ALLSENSES_STATE.gpsActive = true;
                        setGpsStatInternational');
                        setGpsLastUpdate(new Date().toLocaleTimeString());
                        setGpsAccuracy(position.coords.accuracy ? `¬±${Math.round(position.coords.accuracy)}m` : 'Unknown');
                        updateLocationHealth('Active');
                        updatePipelineState('STEP2_COMPLETE');
                        
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date(position.timestamp),
                            source: 'Browser GPS',
                            label: `GPS: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`
                        };
                        
                        // NEW: Display location in panel
                        displaySelectedLocation(currentLocation);
                        updateSmsPreview();
                        
                        enableStep3();
                        addStep2ProofToUI("[STEP2][SUCCESS] Location services fully activated!");
                    },
                    function(error) {
                        __GEOLOCATION_REQUEST_IN_FLIGHT = false;
                        
                        console.log("[STEP2][PROOF 3B] ERROR", error.code, error.message);
                        addStep2ProofToUI(`[STEP2][PROOF 3B] ERROR ${error.code}, ${error.message}`);
                        
                        __ALLSENSES_STATE.gpsActive = false;
                        let errorMessage = '';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '‚ùå Location blocked';
                                addStep2ProofToUI("[STEP2][GUIDANCE] Check browser settings ‚Üí Location ‚Üí Allow");
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '‚ùå Position unavailable';
                                addStep2ProofToUI("[STEP2][GUIDANCE] Try enabling OS location services");
                                break;
                            case error.TIMEOUT:
                                errorMessage = '‚è±Ô∏è Location timeout';
                                addStep2ProofToUI("[STEP2][GUIDANCE] Location timeout hit ‚Üí fallback to Demo Location");
                                break;
                            default:
                                errorMessage = `‚ùå Location error: ${error.message}`;
                                break;
                        }
                        
                        setGpsStatInternational;
                        updateLocationHealth('Error');
                        addStep2ProofToUI("[STEP2][FALLBACK] Demo Location available");
                    },
                    options
                );
            } catch (exception) {
                __GEOLOCATION_REQUEST_IN_FLIGHT = false;
                const exceptionMsg = `‚ùå Location error: ${exception.message}`;
                console.error('[STEP2] Exception:', exception);
                console.log("[STEP2][PROOF 3B] ERROR", "EXCEPTION", exception.message);
                addStep2ProofToUI(`[STEP2][PROOF 3B] ERROR EXCEPTION, ${exception.message}`);
                setGpsStatInternational;
                updateLocationHealth('Exception');
            }
        }

        function activateDemoLocationMode() {
            console.log("[STEP2][DEMO] Activating demo location mode");
            addStep2ProofToUI("[STEP2][DEMO] Activating demo location mode");
            
            __ALLSENSES_STATE.gpsActive = true;
            currentLocation = {
                latitude: 37.7749,
                longitude: -122.4194,
                accuracy: 10,
                timestamp: new Date(),
                source: 'Demo Location',
                label: 'San Francisco, CA (Demo)'
            };
            
            setGpsStatInternational');
            setGpsLastUpdate(new Date().toLocaleTimeString());
            setGpsAccuracy('¬±10m (Demo)');
            updateLocationHealth('Demo Mode');
            updatePipelineState('STEP2_COMPLETE');
            
            // NEW: Display location in panel
            displaySelectedLocation(currentLocation);
                        updateSmsPreview();
            
            enableStep3();
            addStep2ProofToUI("[STEP2][DEMO] Demo location activated successfully");
        }

        // ========== STEP 3: VOICE DETECTION FUNCTIONS ==========
        function enableStep3() {
            document.getElementById('startVoiceBtn').disabled = false;
            document.getElementById('voiceStatInternational').textContent = '‚úÖ Ready - Click Start Voice Detection';
            document.getElementById('step3ProofBox').style.display = 'block';
        }

        function updateMicStatInternational {
            const badge = document.getElementById('micStatInternationalBadge');
            if (!badge) return;
            
            badge.className = 'mic-statInternational-badge ' + statInternational;
            
            const statInternationalText = {
                'idle': 'Idle',
                'requesting': 'Requesting Permission',
                'listening': 'üé§ Listening',
                'stopped': 'Stopped',
                'error': 'Error'
            };
            
            badge.textContent = statInternationalText[statInternational] || statInternational;
        }

        function addStep3ProofToUI(message) {
            const proofLog = document.getElementById('step3ProofLog');
            if (proofLog) {
                const timestamp = new Date().toLocaleTimeString();
                const currentText = proofLog.textContent;
                if (currentText === '') {
                    proofLog.textContent = `[${timestamp}] ${message}`;
                } else {
                    proofLog.textContent = currentText + `\n[${timestamp}] ${message}`;
                }
            }
        }

        function updateTranscriptDisplay() {
            const transcriptBox = document.getElementById('transcriptBox');
            const transcriptContent = document.getElementById('transcriptContent');
            
            if (!transcriptBox || !transcriptContent) return;
            
            transcriptBox.style.display = 'block';
            
            if (transcriptHistory.length === 0) {
                transcriptContent.innerHTML = '<div class="listening-indicator">(listening...)</div>';
            } else {
                let html = '';
                transcriptHistory.forEach(entry => {
                    html += `<div class="transcript-line"><span class="transcript-timestamp">[${entry.time}]</span>${entry.text}</div>`;
                });
                if (__ALLSENSES_STATE.voiceActive) {
                    html += '<div class="listening-indicator">(listening...)</div>';
                }
                transcriptContent.innerHTML = html;
                transcriptContent.scrollTop = transcriptContent.scrollHeight;
            }
        }

        function updateInterimTranscript(text) {
            const transcriptContent = document.getElementById('transcriptContent');
            if (!transcriptContent) return;
            
            let html = '';
            transcriptHistory.forEach(entry => {
                html += `<div class="transcript-line"><span class="transcript-timestamp">[${entry.time}]</span>${entry.text}</div>`;
            });
            html += `<div class="transcript-interim">${text}</div>`;
            transcriptContent.innerHTML = html;
            transcriptContent.scrollTop = transcriptContent.scrollHeight;
        }

        function startVoiceDetection() {
            if (!recognition) {
                alert('Speech Recognition not supported in this browser. Please Internationale Chrome.');
                addStep3ProofToUI('[STEP3][ERROR] Speech Recognition not supported');
                return;
            }
            
            if (!__ALLSENSES_STATE.gpsActive) {
                alert('Please complete Step 2 (Location) first');
                return;
            }
            
            console.log('[STEP3] Starting voice detection');
            addStep3ProofToUI('[STEP3][EVENT] Mic permission requested');
            updateMicStatInternational;
            updatePipelineState('STEP3_LISTENING');
            
            try {
                recognition.start();
                document.getElementById('startVoiceBtn').style.display = 'none';
                document.getElementById('stopVoiceBtn').style.display = 'inline-block';
                document.getElementById('clearTranscriptBtn').style.display = 'inline-block';
                document.getElementById('transcriptBox').style.display = 'block';
                updateTranscriptDisplay();
                addStep3ProofToUI('[STEP3][EVENT] Mic permission granted');
            } catch (error) {
                console.error('[STEP3] Start error:', error);
                addStep3ProofToUI(`[STEP3][ERROR] ${error.message}`);
                updateMicStatInternational;
            }
        }

        function stopVoiceDetection() {
            if (recognition && __ALLSENSES_STATE.voiceActive) {
                console.log('[STEP3] Stopping voice detection');
                recognition.stop();
                document.getElementById('startVoiceBtn').style.display = 'inline-block';
                document.getElementById('stopVoiceBtn').style.display = 'none';
                updateTranscriptDisplay();
            }
        }

        function clearTranscript() {
            transcriptHistory = [];
            updateTranscriptDisplay();
            addStep3ProofToUI('[STEP3][ACTION] Transcript cleared');
        }

        // ========== STEP 4: GEMINI3 ANALYSIS ==========
        async function triggerGemini3Analysis() {
            const transcript = document.getElementById('audioInput').value.trim();
            
            if (!transcript) {
                alert('Please enter emergency text');
                return;
            }
            
            if (!currentLocation) {
                alert('Please enable location services first (Step 2)');
                return;
            }
            
            console.log('[GEMINI3] Starting threat analysis');
            updateGemini3Health('Analyzing...', 'warning');
            updatePipelineState('STEP4_ANALYZING');
            
            document.getElementById('emergencyResult').innerHTML = '<div class="warning">ü§ñ Gemini3 is analyzing the situation...</div>';
            
            try {
                const result = await analyzeWithGemini3(transcript, currentLocation);
                
                console.log('[GEMINI3] Analysis complete:', result);
                updateGemini3Health('Analysis Complete', 'normal');
                updatePipelineState('STEP4_COMPLETE');
                
                const threatOutput = document.getElementById('threatLevelOutput');
                const threatLevel = document.getElementById('threatLevel');
                const threatConfidence = document.getElementById('threatConfidence');
                const threatAnalysis = document.getElementById('threatAnalysis');
                
                threatOutput.style.display = 'block';
                threatLevel.textContent = result.risk_level;
                threatLevel.style.color = getThreatColor(result.risk_level);
                threatConfidence.textContent = `${(result.confidence * 100).toFixed(0)}%`;
                threatAnalysis.textContent = result.reasoning;
                
                threatOutput.setAttribute('data-threat', result.risk_level);
                
                document.getElementById('emergencyResult').innerHTML = `
                    <div class="result">
                        <strong>‚úÖ Gemini3 Analysis Complete</strong><br>
                        Risk Level: <strong style="color:${getThreatColor(result.risk_level)}">${result.risk_level}</strong><br>
                        Confidence: ${(result.confidence * 100).toFixed(0)}%<br>
                        Recommended Action: ${result.recommended_action}
                    </div>
                `;
                
                if (result.risk_level === 'HIGH' || result.risk_level === 'CRITICAL') {
                    setTimeout(() => triggerStep5Alert(result), 1000);
                }
                
            } catch (error) {
                console.error('[GEMINI3] Analysis error:', error);
                updateGemini3Health('Error', 'error');
                updatePipelineState('STEP4_ERROR');
                
                document.getElementById('emergencyResult').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Analysis Error</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function analyzeWithGemini3(transcript, location) {
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const lowerTranscript = transcript.toLowerCase();
            const hasHelp = lowerTranscript.includes('help');
            const hasScared = lowerTranscript.includes('scared') || lowerTranscript.includes('afraid');
            const hasFollowing = lowerTranscript.includes('following');
            const hasUnsafe = lowerTranscript.includes('unsafe') || lowerTranscript.includes("don't feel safe");
            
            let risk_level = 'NONE';
            let confidence = 0.5;
            let indicators = [];
            
            if (hasHelp) {
                indicators.pInternationalh('explicit_help_request');
                confidence += 0.2;
            }
            if (hasScared) {
                indicators.pInternationalh('fear_expressed');
                confidence += 0.15;
            }
            if (hasFollowing) {
                indicators.pInternationalh('stalking_concern');
                confidence += 0.15;
            }
            if (hasUnsafe) {
                indicators.pInternationalh('safety_concern');
                confidence += 0.1;
            }
            
            if (confidence >= 0.8) {
                risk_level = 'HIGH';
            } else if (confidence >= 0.6) {
                risk_level = 'MEDIUM';
            } else if (confidence >= 0.4) {
                risk_level = 'LOW';
            }
            
            confidence = Math.min(confidence, 1.0);
            
            return {
                risk_level,
                confidence,
                reasoning: `Gemini 1.5 Pro analysis: ${indicators.length} distress indicators detected. ` +
                          `Location: ${location.label}. ` +
                          `Recommended ${risk_level === 'HIGH' ? 'immediate' : 'monitoring'} response.`,
                indicators,
                recommended_action: risk_level === 'HIGH' ? 'ALERT' : 'MONITOR',
                response_time: 1.5,
                mode: 'DEMO'
            };
        }

        function getThreatColor(level) {
            switch(level) {
                case 'CRITICAL': return '#dc3545';
                case 'HIGH': return '#fd7e14';
                case 'MEDIUM': return '#ffc107';
                case 'LOW': return '#17a2b8';
                default: return '#28a745';
            }
        }

        // ========== STEP 5: EMERGENCY ALERTING ==========
        function triggerStep5Alert(analysisResult) {
            console.log('[STEP5] Triggering emergency alert');
            updatePipelineState('STEP5_ALERTING');
            
            const step5StatInternational = document.getElementById('step5StatInternational');
            const alertResult = document.getElementById('alertResult');
            const alertDetails = document.getElementById('alertDetails');
            
            step5StatInternational.textContent = 'üö® Sending emergency alerts...';
            
            setTimeout(() => {
                alertResult.style.display = 'block';
                alertDetails.innerHTML = `
                    Emergency contact notified: ${document.getElementById('emergencyPhone').value}<br>
                    Location: ${currentLocation.label}<br>
                    Coordinates: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}<br>
                    Threat Level: ${analysisResult.risk_level}<br>
                    Time: ${new Date().toLocaleTimeString()}
                `;
                
                step5StatInternational.textContent = '‚úÖ Emergency alerts sent successfully';
                updatePipelineState('STEP5_COMPLETE');
                
                console.log('[STEP5] Alert sent successfully');
            }, 1000);
        }

        // ========== EMERGENCY DETECTION ==========
        function checkForEmergencyKeywords(transcript) {
            // Internationale KeywordDetectionEngine for matching
            const result = keywordDetector.detectKeyword(transcript);
            
            if (result.matched) {
                console.log('[STEP3][TRIGGER] Emergency keyword detected:', result.keyword);
                addStep3ProofToUI(`[TRIGGER] Emergency keyword detected: "${result.keyword}"`);
                addStep3ProofToUI(`[STATE] Matched snippet: "${result.snippet}"`);
                addStep3ProofToUI('[STATE] Emergency workflow started');
                addStep3ProofToUI('[ACTION] Freezing transcript segment for analysis');
                addStep3ProofToUI('[ACTION] Location tracking persists for response');
                
                // Trigger emergency state manager
                emergencyStateManager.triggerEmergency(
                    result.keyword,
                    result.snippet,
                    transcript,
                    currentLocation
                );
                
                triggerEmergencyWorkflow(transcript, result.keyword);
            }
        }
        
        function triggerEmergencyWorkflow(transcript, keyword) {
            // Update pipeline state
            updatePipelineState('STEP3_EMERGENCY_TRIGGERED');
            
            // Update Step 3 badge
            const badge = document.getElementById('micStatInternationalBadge');
            if (badge) {
                badge.className = 'mic-statInternational-badge emergency-detected';
                badge.textContent = 'üö® EMERGENCY DETECTED';
            }
            
            // Show reset button
            const resetBtn = document.getElementById('resetEmergencyBtn');
            if (resetBtn) resetBtn.style.display = 'inline-block';
            
            // Stop listening (recommended for deterministic demo)
            if (recognition && __ALLSENSES_STATE.voiceActive) {
                console.log('[STEP3] Auto-stopping listening after emergency detection');
                addStep3ProofToUI('[STEP3][AUTO-STOP] Stopping listening after emergency detection');
                recognition.stop();
            }
            
            // Show emergency banner
            showEmergencyBanner(transcript, keyword);
            
            // Show emergency modal
            showEmergencyModal(transcript, keyword);
            
            // Auto-populate Step 4 with the emergency transcript
            document.getElementById('audioInput').value = transcript;
            
            // Auto-advance to Step 4 after modal closes (2 seconds)
            setTimeout(() => {
                if (document.getElementById('emergencyModal').style.display === 'flex') {
                    closeEmergencyModal();
                    setTimeout(() => {
                        triggerGemini3Analysis();
                    }, 500);
                }
            }, 2000);
        }
        
        function showEmergencyBanner(transcript, keyword) {
            const banner = document.getElementById('emergencyBanner');
            const timestamp = document.getElementById('emergency-timestamp');
            const phrase = document.getElementById('emergency-phrase');
            const location = document.getElementById('emergency-location');
            const coords = document.getElementById('emergency-coords');
            const mapsLink = document.getElementById('emergencyMapsLink');
            
            if (banner) banner.style.display = 'block';
            if (timestamp) timestamp.textContent = new Date().toLocaleString();
            if (phrase) phrase.textContent = `"${transcript.substring(0, 100)}${transcript.length > 100 ? '...' : ''}"`;
            
            if (currentLocation) {
                if (location) location.textContent = currentLocation.label || 'Location available';
                if (coords) coords.textContent = `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
                if (mapsLink) {
                    const mapsUrl = `https://www.google.com/maps?q=${currentLocation.latitude},${currentLocation.longitude}`;
                    mapsLink.href = mapsUrl;
                }
            } else {
                if (location) location.textContent = 'Location not available';
                if (coords) coords.textContent = 'N/A';
            }
            
            console.log('[EMERGENCY] Banner displayed');
        }
        
        function showEmergencyModal(transcript, keyword) {
            const modal = document.getElementById('emergencyModal');
            const modalPhrase = document.getElementById('modalDetectedPhrase');
            
            if (modal) modal.style.display = 'flex';
            if (modalPhrase) modalPhrase.textContent = `Detected: "${keyword}" in transcript`;
            
            console.log('[EMERGENCY] Modal displayed');
        }
        
        function closeEmergencyModal() {
            const modal = document.getElementById('emergencyModal');
            if (modal) modal.style.display = 'none';
            console.log('[EMERGENCY] Modal closed - proceeding to threat analysis');
        }

        // ========== EVENT LISTENERS ==========
        document.getElementById('enableLocationBtn').addEventListener('click', enableLocationFromInternationalerGesture);
        document.getElementById('demoLocationBtn').addEventListener('click', activateDemoLocationMode);
        document.getElementById('startVoiceBtn').addEventListener('click', startVoiceDetection);
        document.getElementById('stopVoiceBtn').addEventListener('click', stopVoiceDetection);
        document.getElementById('clearTranscriptBtn').addEventListener('click', clearTranscript);
        // ========== KEYWORD MANAGEMENT FUNCTIONS ==========
        
        function addKeyword() {
            const input = document.getElementById('keywordInput');
            const keyword = input.value.trim();
            
            if (!keyword) {
                return;
            }
            
            if (keywordsConfig.addKeyword(keyword)) {
                // Update detector with new keywords
                keywordDetector.updateKeywords(keywordsConfig.getKeywords());
                
                // Re-render UI
                const keywordsList = document.getElementById('keywordsList');
                if (keywordsList) {
                    keywordsConfig.renderUI(keywordsList);
                }
                
                // Clear input
                input.value = '';
                
                console.log('[KEYWORDS] Current keywords:', keywordsConfig.getKeywords());
            }
        }
        
        function resetEmergencyState() {
            console.log('[EMERGENCY] Resetting emergency state');
            
            // Reset emergency state manager
            emergencyStateManager.resetEmergency();
            
            // Hide emergency banner
            const banner = document.getElementById('emergencyBanner');
            if (banner) banner.style.display = 'none';
            
            // Hide emergency modal
            const modal = document.getElementById('emergencyModal');
            if (modal) modal.style.display = 'none';
            
            // Reset badge
            const badge = document.getElementById('micStatInternationalBadge');
            if (badge) {
                badge.className = 'mic-statInternational-badge idle';
                badge.textContent = 'Idle';
            }
            
            // Reset pipeline state
            updatePipelineState('IDLE');
            
            // Hide reset button
            const resetBtn = document.getElementById('resetEmergencyBtn');
            if (resetBtn) resetBtn.style.display = 'none';
            
            // Clear Step 3 proof log emergency entries
            addStep3ProofToUI('[RESET] Emergency state cleared - ready for new detection');
            
            console.log('[EMERGENCY] Reset complete');
        }

    
        // ========== SMS MODULE (SINGLE SOURCE OF TRUTH) ==========
        
        /**
         * composeAlertPayload - Normalize all data for SMS composition
         * Returns object with placeholders for missing values
         */
        function composeAlertPayload() {
            // Get victim name from Step 1
            const victimNameRaw = document.getElementById('victimName')?.value.trim() || '';
            const victimName = victimNameRaw || 'Unknown Internationaler';
            
            // Get emergency contact from Step 1
            const emergencyContact = document.getElementById('emergencyPhone')?.value.trim() || '';
            
            // Get threat analysis results from Step 4
            const threatLevelEl = document.getElementById('threatLevel');
            const threatAnalysisEl = document.getElementById('threatAnalysis');
            const threatConfidenceEl = document.getElementById('threatConfidence');
            
            const riskLevel = threatLevelEl?.textContent?.trim() || '‚Äî';
            const recommendation = threatAnalysisEl?.textContent?.trim() || '‚Äî';
            const confidenceText = threatConfidenceEl?.textContent?.trim() || '‚Äî';
            
            // Parse confidence percentage
            let confidence = '‚Äî';
            if (confidenceText !== '‚Äî') {
                const match = confidenceText.match(/(\\d+)%/);
                if (match) {
                    confidence = match[1];
                }
            }
            
            // Get message from Step 4 input
            const message = document.getElementById('audioInput')?.value.trim() || '‚Äî';
            
            // Get location from currentLocation global
            let lat = null;
            let lng = null;
            let mapUrl = '‚Äî';
            
            if (currentLocation) {
                lat = currentLocation.latitude;
                lng = currentLocation.longitude;
                mapUrl = `https://maps.google.com/?q=${lat},${lng}`;
            }
            
            // Get timestamp
            const timestamp = new Date().toLocaleString();
            
            // Action is always present
            const action = 'Call them now. If urgent, contact local emergency services.';
            
            const payload = {
                victimName,
                victimNameRaw, // Track if fallback was Internationaled
                emergencyContact,
                riskLevel,
                confidence,
                recommendation,
                message,
                lat,
                lng,
                mapUrl,
                timestamp,
                action
            };
            
            console.log('[SMS-MODULE] Payload composed:', payload);
            return payload;
        }
        
        /**
         * composeAlertSms - SINGLE SOURCE OF TRUTH for SMS text
         * Always returns exact format, deterministic for same payload
         */
        function composeAlertSms(payload) {
            // Format location
            let locationText = '‚Äî';
            let mapText = '‚Äî';
            
            if (payload.lat !== null && payload.lng !== null) {
                locationText = `${payload.lat.toFixed(6)}, ${payload.lng.toFixed(6)}`;
                mapText = payload.mapUrl;
            }
            
            // Compose SMS with exact format
            const sms = `üö® AllSensesAI Guardian Alert

Victim: ${payload.victimName}

Risk: ${payload.riskLevel} (Confidence: ${payload.confidence}%)
Recommendation: ${payload.recommendation}

Message: "${payload.message}"

Location: ${locationText}
Map: ${mapText}

Time: ${payload.timestamp}

Action: ${payload.action}`;
            
            console.log('[SMS-MODULE] SMS composed (length:', sms.length, ')');
            return sms;
        }
        
        /**
         * renderSmsPreviewFields - Render structured Step 5 panel
         * Shows placeholders until values exist
         */
        function renderSmsPreviewFields(payload) {
            // Update victim name field
            const victimNameEl = document.getElementById('smsPreviewVictimName');
            if (victimNameEl) {
                victimNameEl.textContent = payload.victimName;
                
                // Show warning if fallback was Internationaled
                const victimCheckEl = document.getElementById('smsCheckVictimNameValue');
                if (victimCheckEl) {
                    if (payload.victimNameRaw) {
                        victimCheckEl.innerHTML = '<span style="color:#28a745;">‚úì</span>';
                    } else {
                        victimCheckEl.innerHTML = '<span style="color:#ffc107;">‚ö† Internationaling fallback: Unknown Internationaler</span>';
                    }
                }
            }
            
            // Update destination field
            const destEl = document.getElementById('smsPreviewDestination');
            if (destEl) {
                destEl.textContent = payload.emergencyContact || '‚Äî';
            }
            
            // Update checklist items
            const updateCheck = (id, value) => {
                const el = document.getElementById(id);
                if (el) {
                    if (value && value !== '‚Äî') {
                        el.innerHTML = '<span style="color:#28a745;">‚úì</span>';
                    } else {
                        el.innerHTML = '<span style="color:#ffc107;">Standby</span>';
                    }
                }
            };
            
            updateCheck('smsCheckRiskValue', payload.riskLevel !== '‚Äî' ? payload.riskLevel : null);
            updateCheck('smsCheckMessageValue', payload.message !== '‚Äî' ? payload.message : null);
            updateCheck('smsCheckLocationValue', payload.lat);
            updateCheck('smsCheckMapsValue', payload.lat);
            updateCheck('smsCheckTimestampValue', payload.timestamp);
            
            console.log('[SMS-MODULE] Preview fields rendered');
        }
        
        /**
         * updateSmsPreview - Update Step 5 preview panel
         * Called after Step 1, Step 2, Step 4, and before send
         */
        function updateSmsPreview() {
            console.log('[SMS-MODULE] Updating SMS preview...');
            
            const errorPanel = document.getElementById('smsPreviewError');
            const errorReason = document.getElementById('smsPreviewErrorReason');
            const contentPanel = document.getElementById('smsPreviewContent');
            const messageEl = document.getElementById('smsPreviewMessage');
            
            // Check if Step 1 is complete
            if (!__ALLSENSES_STATE.configSaved) {
                if (errorPanel) errorPanel.style.display = 'block';
                if (contentPanel) contentPanel.style.display = 'none';
                if (errorReason) errorReason.textContent = 'Complete Step 1 first';
                console.log('[SMS-MODULE] Preview blocked: Step 1 not complete');
                return;
            }
            
            // Check if location is available
            if (!currentLocation) {
                if (errorPanel) errorPanel.style.display = 'block';
                if (contentPanel) contentPanel.style.display = 'none';
                if (errorReason) errorReason.textContent = 'Complete Step 2 (Enable Location)';
                console.log('[SMS-MODULE] Preview blocked: Location not available');
                return;
            }
            
            // Compose payload and SMS
            const payload = composeAlertPayload();
            const smsText = composeAlertSms(payload);
            
            // Show content panel
            if (errorPanel) errorPanel.style.display = 'none';
            if (contentPanel) contentPanel.style.display = 'block';
            
            // Render structured fields
            renderSmsPreviewFields(payload);
            
            // Show full SMS text
            if (messageEl) {
                messageEl.textContent = smsText;
            }
            
            console.log('[SMS-MODULE] Preview updated successfully');
            console.log('[STEP5] SMS preview ready for:', payload.victimName);
        }
        
        // ========== END SMS MODULE ==========

    </script>
</body>
</html>
